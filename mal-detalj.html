<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mål · Detaljer · Easylife</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --sidebar-bg: linear-gradient(180deg, #101828 0%, #020617 100%);
      --sidebar-width: 260px;
      --card-bg: rgba(255, 255, 255, 0.08);
      --text-primary: #0f1c2e;
      --text-secondary: rgba(15, 28, 46, 0.64);
      --surface: rgba(255, 255, 255, 0.55);
      --surface-border: rgba(255, 255, 255, 0.35);
      --chip-bg: rgba(15, 28, 46, 0.55);
    }

    * { box-sizing: border-box; }

    /* Sørg for at hidden-attributtet alltid skjuler elementer */
    [hidden] {
      display: none !important;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(120% 120% at 10% 0%, rgba(201, 226, 255, 0.9) 0%, rgba(228, 241, 255, 0.9) 45%, rgba(196, 215, 238, 0.95) 100%), #f1f5f9;
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      color: rgba(255, 255, 255, 0.92);
      padding: 16px 24px 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: relative;
      box-shadow: 12px 0 32px rgba(18, 38, 63, 0.25);
      z-index: 2;
    }

    .logo {
      display: block;
    }

    .logo img {
      display: block;
      width: 160px;
      max-width: 100%;
      height: auto;
    }

    .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .menu a {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      border-radius: 14px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      font-weight: 500;
      transition: background 160ms ease, color 160ms ease;
    }

    .menu a.active,
    .menu a:hover,
    .menu a:focus-visible {
      background: rgba(255, 255, 255, 0.18);
      color: #ffffff;
      outline: none;
    }

    .menu a .icon {
      display: inline-flex;
      width: 32px;
      height: 32px;
      border-radius: 12px;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    .menu a .icon img {
      max-width: 20px;
      max-height: 20px;
      width: 20px;
      height: 20px;
      object-fit: contain;
    }

    main {
      flex: 1;
      padding: 48px clamp(24px, 4vw, 64px);
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    h1 {
      margin: 0;
      font-size: clamp(2rem, 2vw + 1rem, 2.75rem);
    }

    p {
      margin: 0;
      color: var(--text-secondary);
      max-width: 620px;
      line-height: 1.6;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .goal-detail {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .goal-detail__back {
      align-self: flex-start;
      background: transparent;
      border: none;
      padding: 0;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: color 160ms ease;
    }

    .goal-detail__back:hover,
    .goal-detail__back:focus-visible {
      color: #0f172a;
      outline: none;
    }

    .goal-detail__hero {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 32px;
      align-items: flex-start;
    }

    .goal-detail__image {
      border-radius: 28px;
      overflow: hidden;
      position: relative;
      min-height: 240px;
      max-height: 320px;
      background: rgba(15, 28, 46, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .goal-detail__image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .goal-detail__info {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .goal-detail__info h2 {
      margin: 0;
      font-size: clamp(2rem, 1vw + 1.5rem, 2.5rem);
    }

    .goal-detail__meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .goal-detail__meta-item {
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 18px;
      border: 1px solid rgba(15, 28, 46, 0.08);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .goal-detail__meta-item span:first-child {
      font-size: 0.8rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: rgba(15, 28, 46, 0.58);
    }

    .goal-detail__meta-item span:last-child {
      font-weight: 600;
      color: #0f172a;
    }

    .goal-detail__layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(280px, 360px);
      gap: 32px;
      align-items: flex-start;
    }

    .goal-section {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 28px;
      border: 1px solid rgba(15, 28, 46, 0.08);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .goal-section__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .goal-section__actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .goal-icon-button {
      border: 1px solid #ffffff;
      background: #ffffff;
      color: #0f172a;
      width: 38px;
      height: 38px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      transition: background 160ms ease, border-color 160ms ease, color 160ms ease, transform 160ms ease;
      position: relative;
    }

    .goal-icon-button svg {
      width: 18px;
      height: 18px;
      pointer-events: none;
    }

    .goal-icon-button:hover,
    .goal-icon-button:focus-visible {
      background: rgba(148, 163, 184, 0.14);
      border-color: rgba(15, 28, 46, 0.18);
      color: #020617;
      transform: translateY(-1px);
      outline: none;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.18);
    }

    .goal-icon-button[data-state="open"],
    .goal-icon-button[aria-pressed="true"] {
      background: rgba(148, 163, 184, 0.18);
      border-color: rgba(15, 28, 46, 0.22);
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.18);
    }

    .goal-icon-button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .goal-section__action-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .goal-section__header h3 {
      margin: 0;
      font-size: 1.3rem;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--chip-bg);
      color: rgba(255, 255, 255, 0.9);
    }

    .chip--light {
      background: rgba(15, 28, 46, 0.08);
      color: rgba(15, 28, 46, 0.85);
    }

    .goal-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .goal-list__item {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 18px 20px;
      border: 1px solid rgba(15, 28, 46, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    .goal-list__item::after {
      content: '';
      position: absolute;
      left: 24px;
      right: 24px;
      bottom: -9px;
      height: 2px;
      background: rgba(15, 28, 46, 0.08);
      border-radius: 999px;
      opacity: 0;
      transition: opacity 160ms ease;
    }

    .goal-list__item.is-drag-over::after {
      opacity: 1;
    }

    .goal-list__label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .goal-list__label span:first-child {
      font-weight: 600;
    }

    .goal-list__label span:not(:first-child) {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .goal-milestone__deadline {
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .goal-milestone__deadline::before {
      content: '⏰';
      font-size: 0.9rem;
    }

    .goal-milestone__header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .goal-milestone__info {
      display: flex;
      align-items: flex-start;
      gap: 18px;
      flex: 1;
      min-width: 0;
    }

    .goal-milestone__status {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-width: 56px;
    }

    .goal-milestone__status-ring {
      --goal-status-color: #6366f1;
      --goal-status-background: rgba(148, 163, 184, 0.25);
      --goal-status-degree: 0deg;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: conic-gradient(var(--goal-status-color) var(--goal-status-degree), var(--goal-status-background) 0deg);
      display: grid;
      place-items: center;
      position: relative;
      color: #1f2937;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .goal-milestone__status-ring::after {
      content: '';
      position: absolute;
      inset: 6px;
      background: #ffffff;
      border-radius: 50%;
    }

    .goal-milestone__status-count {
      position: relative;
      z-index: 1;
    }

    .goal-milestone__status-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: rgba(15, 28, 46, 0.6);
      font-weight: 600;
    }

    .goal-milestone__actions {
      display: inline-flex;
      align-items: flex-start;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .goal-milestone__edit,
    .goal-milestone__toggle,
    .goal-milestone__todo-add {
      font: inherit;
    }

    .goal-milestone__todos {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .goal-milestone__todo-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .goal-milestone__todo-content .empty-state {
      margin: 0;
    }

    .goal-milestone__todo-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .goal-milestone__todo-item {
      background: rgba(248, 250, 252, 0.9);
      border-radius: 12px;
      padding: 6px 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .goal-milestone__todo-item[data-completed="true"] {
      background: rgba(226, 232, 240, 0.7);
      border-color: rgba(148, 163, 184, 0.45);
    }

    .goal-list__todo {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      width: 100%;
      justify-content: space-between;
    }

    .goal-list__todo-main {
      display: inline-flex;
      align-items: flex-start;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .goal-list__todo-actions {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .goal-list__todo label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      font-weight: 400;
      color: #0f172a;
    }

    .goal-list__todo-title {
      font-weight: 400;
    }

    .goal-milestone__todo-item[data-completed="true"] .goal-list__todo-title {
      text-decoration: line-through;
      color: rgba(15, 28, 46, 0.6);
    }

    .goal-list__todo input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #2563eb;
      flex-shrink: 0;
    }

    .goal-milestone__todo-delete {
      border: none;
      background: transparent;
      color: #b91c1c;
      padding: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 160ms ease;
    }

    .goal-milestone__todo-delete svg {
      width: 18px;
      height: 18px;
    }

    .goal-milestone__todo-delete:hover,
    .goal-milestone__todo-delete:focus-visible {
      color: #7f1d1d;
    }

    .goal-milestone__todo-delete:focus-visible {
      outline: 2px solid rgba(185, 28, 28, 0.4);
      border-radius: 6px;
    }

    .goal-milestone__todo-form {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 12px;
      align-items: center;
      padding: 16px;
      border-radius: 16px;
      border: 1px dashed rgba(37, 99, 235, 0.35);
      background: rgba(248, 250, 252, 0.9);
    }

    .goal-milestone__todo-form[hidden] {
      display: none;
    }

    .goal-milestone__todo-form input[type="text"] {
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      padding: 10px 12px;
      font-size: 0.95rem;
    }

    .goal-milestone__todo-form button[type="submit"] {
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      padding: 10px 14px;
      width: 48px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      font-weight: 600;
      cursor: pointer;
    }

    .goal-milestone__todo-form button[type="submit"]:hover,
    .goal-milestone__todo-form button[type="submit"]:focus-visible {
      background: #1d4ed8;
      outline: none;
    }

    .goal-section__form {
      padding: 18px;
      border-radius: 20px;
      border: 1px dashed rgba(37, 99, 235, 0.35);
      background: rgba(248, 250, 252, 0.9);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .goal-section__form[hidden] {
      display: none;
    }

    .goal-section__form input[type="text"] {
      flex: 1;
      min-width: 160px;
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      padding: 10px 12px;
      font-size: 0.95rem;
    }

    .goal-section__form button[type="submit"] {
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
    }

    .goal-section__form button[type="submit"]:hover,
    .goal-section__form button[type="submit"]:focus-visible {
      background: #1d4ed8;
      outline: none;
    }

    .goal-sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }


    .goal-detail__notes {
      position: sticky;
      top: 48px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .goal-notes {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .goal-notes__actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      width: 100%;
    }

    .goal-notes__search {
      flex: 1;
      min-width: 160px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      font-size: 0.95rem;
    }

    .goal-notes__add {
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      transition: background 160ms ease;
    }

    .goal-notes__add:hover,
    .goal-notes__add:focus-visible {
      background: #1d4ed8;
      outline: none;
    }

    .goal-note {
      border-radius: 18px;
      border: 1px solid rgba(15, 28, 46, 0.08);
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      transition: transform 160ms ease, box-shadow 160ms ease;
    }

    .goal-note:hover,
    .goal-note:focus-visible {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(15, 28, 46, 0.16);
      outline: none;
    }

    .goal-note h4 {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .goal-note p {
      margin: 0;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .empty-state {
      border-radius: 20px;
      border: 1px dashed rgba(15, 28, 46, 0.12);
      padding: 24px;
      text-align: center;
      color: var(--text-secondary);
      font-weight: 500;
      background: rgba(255, 255, 255, 0.75);
    }

    .note-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 28, 46, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10;
    }

    .note-modal[hidden] {
      display: none;
    }

    .note-modal__dialog {
      background: #ffffff;
      border-radius: 24px;
      max-width: 480px;
      width: min(100%, 480px);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }

    .note-modal__dialog--form {
      max-width: 520px;
    }

    .note-modal__dialog button[type="button"] {
      align-self: flex-end;
      border: none;
      background: transparent;
      font-weight: 600;
      cursor: pointer;
    }

    .note-modal__dialog h3 {
      margin: 0;
      font-size: 1.4rem;
    }

    .note-modal__dialog p {
      margin: 0;
      color: var(--text-secondary);
      white-space: pre-wrap;
    }

    .stacked-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stacked-form input,
    .stacked-form textarea {
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      padding: 10px 12px;
      font-size: 0.95rem;
    }

    .stacked-form button[type="submit"] {
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
    }

    @media (max-width: 1080px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 24px;
        gap: 20px;
      }

      .menu {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .goal-detail__hero {
        grid-template-columns: 1fr;
      }

      .goal-detail__layout {
        grid-template-columns: 1fr;
      }

      .goal-detail__notes {
        position: static;
      }

      .goal-section {
        padding: 18px;
      }

      .goal-section__form {
        flex-direction: column;
        align-items: stretch;
      }

      .goal-section__form button[type="submit"] {
        width: 100%;
      }

      .goal-milestone__todo-form {
        grid-template-columns: 1fr;
      }

      .goal-milestone__todo-form button[type="submit"] {
        width: 100%;
      }

      .goal-milestone__actions {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">
      <img src="images/logo%20white.png" alt="Easylife logo" />
    </div>
    <nav class="menu" aria-label="Hovedmeny">
      <a href="index.html"><span class="icon"><img src="images/Icon_home2.png" alt="Hjem" /></span>Dashboard</a>
      <a class="active" href="mal.html"><span class="icon"><img src="images/Icon_goal2.png" alt="Mål" /></span>Mål</a>
      <a href="todo.html"><span class="icon"><img src="images/Icon_todo2.png" alt="Todo" /></span>Todo</a>
      <a href="rutiner.html"><span class="icon"><img src="images/Icon_routine2.png" alt="Rutiner" /></span>Rutiner</a>
      <a href="training.html"><span class="icon"><img src="images/Icon_train2.png" alt="Trening" /></span>Training og kostholdsplan</a>
    </nav>
  </aside>
  <main>
    <section class="goal-detail" id="goal-detail" aria-live="polite" hidden>
      <button class="goal-detail__back" type="button" id="goal-detail-back">← Tilbake til oversikten</button>
      <div class="goal-detail__hero">
        <div class="goal-detail__image">
          <img id="goal-detail-image" src="" alt="" loading="lazy" />
        </div>
        <div class="goal-detail__info">
          <h2 id="goal-detail-title"></h2>
          <p id="goal-detail-why"></p>
          <div class="goal-detail__meta">
            <div class="goal-detail__meta-item">
              <span>Deadline</span>
              <span id="goal-detail-deadline"></span>
            </div>
            <div class="goal-detail__meta-item">
              <span>Kategori</span>
              <span id="goal-detail-category"></span>
            </div>
            <div class="goal-detail__meta-item">
              <span>Hvorfor det er viktig</span>
              <span id="goal-detail-important"></span>
            </div>
          </div>
        </div>
      </div>
      <div class="goal-detail__layout">
        <div class="goal-detail__main">
          <section class="goal-section" aria-labelledby="goal-milestones-title">
            <div class="goal-section__header">
              <h3 id="goal-milestones-title">Milepæler</h3>
              <div class="goal-section__actions">
                <button type="button" class="goal-section__action-button goal-icon-button" id="goal-milestone-toggle-all" aria-pressed="false">
                  <span class="goal-sr-only">Skjul alle milepæl to-dos</span>
                </button>
                <button type="button" class="goal-section__action-button goal-icon-button" id="goal-milestone-add-button" aria-expanded="false">
                  <span class="goal-sr-only">Legg til milepæl</span>
                </button>
              </div>
            </div>
            <ul class="goal-list goal-milestone-list" id="goal-milestone-list"></ul>
            <form class="goal-section__form" id="goal-milestone-form" hidden>
              <input type="text" name="milestone-title" placeholder="Legg til milepæl" required />
              <input type="text" name="milestone-detail" placeholder="Detaljer (valgfritt)" />
              <button type="submit">Legg til</button>
            </form>
          </section>
        </div>
        <aside class="goal-detail__notes">
          <section class="goal-section" aria-labelledby="goal-notes-title">
            <div class="goal-section__header">
              <h3 id="goal-notes-title">Notater</h3>
              <div class="goal-notes__actions">
                <input type="search" id="goal-notes-search" class="goal-notes__search" placeholder="Søk i notater" aria-label="Søk i notater" />
                <button type="button" class="goal-notes__add" id="goal-add-note">Nytt notat</button>
              </div>
            </div>
            <div class="goal-notes" id="goal-notes-list"></div>
          </section>
        </aside>
      </div>
    </section>
    <section class="empty-state" id="goal-detail-empty" hidden>
      Kunne ikke finne dette målet. <a href="mal.html">Gå tilbake til oversikten.</a>
    </section>
  </main>
  <div class="note-modal" id="goal-note-modal" role="dialog" aria-modal="true" aria-hidden="true" hidden>
    <div class="note-modal__dialog">
      <button type="button" id="goal-note-close">Lukk</button>
      <h3 id="goal-note-modal-title"></h3>
      <p id="goal-note-modal-content"></p>
    </div>
  </div>
  <div class="note-modal" id="goal-note-create-modal" role="dialog" aria-modal="true" aria-hidden="true" hidden>
    <div class="note-modal__dialog note-modal__dialog--form">
      <button type="button" id="goal-note-create-close">Lukk</button>
      <h3>Ny notat</h3>
      <form class="stacked-form" id="goal-note-create-form">
        <input type="text" name="note-title" placeholder="Tittel" required />
        <textarea name="note-content" rows="4" placeholder="Skriv notat" required></textarea>
        <button type="submit">Lagre notat</button>
      </form>
    </div>
  </div>
  <div class="note-modal" id="goal-milestone-edit-modal" role="dialog" aria-modal="true" aria-hidden="true" hidden>
    <div class="note-modal__dialog note-modal__dialog--form">
      <button type="button" id="goal-milestone-edit-close">Lukk</button>
      <h3>Rediger milepæl</h3>
      <form class="stacked-form" id="goal-milestone-edit-form">
        <input type="text" name="milestone-title" placeholder="Tittel" aria-label="Tittel" required />
        <textarea name="milestone-detail" rows="3" placeholder="Detaljer" aria-label="Detaljer"></textarea>
        <input type="date" name="milestone-deadline" aria-label="Deadline" />
        <button type="submit">Lagre milepæl</button>
      </form>
    </div>
  </div>
  <script src="goals-data.js"></script>
  <script type="module">
    import supabaseClient from './supabase-client.js';

    (async function () {
      const baseGoalsData = window.EASYLIFE_GOALS_DATA || [];
      const cloneGoal = (goal) => JSON.parse(JSON.stringify(goal || {}));
      const ICON_MARKUP = {
        plus: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="M10 4.167v11.666M4.167 10h11.666" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        close: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="m5.5 5.5 9 9m0-9-9 9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        chevronsDown: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="m5.25 6.75 4.75 4.75 4.75-4.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            <path d="m5.25 11.25 4.75 4.75 4.75-4.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        chevronsUp: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="m5.25 13.25 4.75-4.75 4.75 4.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            <path d="m5.25 8.75 4.75-4.75 4.75 4.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        pencil: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25-3.664.836.836-3.664 8.25-8.25Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M11.75 5.422 14.58 8.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        x: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="m6 6 8 8m0-8-8 8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `
      };

      const getIconMarkup = (name) => (ICON_MARKUP[name] || '').trim();

      const setButtonIconContent = (button, iconName, srText = '') => {
        if (!button) {
          return;
        }

        button.innerHTML = getIconMarkup(iconName);
        if (srText) {
          const srSpan = document.createElement('span');
          srSpan.className = 'goal-sr-only';
          srSpan.textContent = srText;
          button.appendChild(srSpan);
        }
      };
      const parseIndexParam = (value) => {
        if (typeof value !== 'string') {
          return Number.NaN;
        }

        const trimmed = value.trim();
        if (!/^\d+$/.test(trimmed)) {
          return Number.NaN;
        }

        return Number.parseInt(trimmed, 10);
      };

      const goalDetailSection = document.getElementById('goal-detail');
      const emptyStateSection = document.getElementById('goal-detail-empty');
      const goalDetailBackButton = document.getElementById('goal-detail-back');
      const goalDetailImage = document.getElementById('goal-detail-image');
      const goalDetailTitle = document.getElementById('goal-detail-title');
      const goalDetailWhy = document.getElementById('goal-detail-why');
      const goalDetailDeadline = document.getElementById('goal-detail-deadline');
      const goalDetailCategory = document.getElementById('goal-detail-category');
      const goalDetailImportant = document.getElementById('goal-detail-important');
      const milestoneList = document.getElementById('goal-milestone-list');
      const milestoneToggleAllButton = document.getElementById('goal-milestone-toggle-all');
      const milestoneFormToggle = document.getElementById('goal-milestone-add-button');
      const milestoneForm = document.getElementById('goal-milestone-form');
      const notesList = document.getElementById('goal-notes-list');
      const notesSearchInput = document.getElementById('goal-notes-search');
      const addNoteButton = document.getElementById('goal-add-note');
      const noteModal = document.getElementById('goal-note-modal');
      const noteModalTitle = document.getElementById('goal-note-modal-title');
      const noteModalContent = document.getElementById('goal-note-modal-content');
      const noteModalClose = document.getElementById('goal-note-close');
      const noteCreateModal = document.getElementById('goal-note-create-modal');
      const noteCreateClose = document.getElementById('goal-note-create-close');
      const noteCreateForm = document.getElementById('goal-note-create-form');
      const milestoneEditModal = document.getElementById('goal-milestone-edit-modal');
      const milestoneEditClose = document.getElementById('goal-milestone-edit-close');
      const milestoneEditForm = document.getElementById('goal-milestone-edit-form');

      const currentUrl = new URL(window.location.href);
      const goalParam = currentUrl.searchParams.get('goal');
      const fallbackGoalParam = currentUrl.searchParams.get('goalIndex');

      const parsedGoalIndex = parseIndexParam(goalParam);
      const parsedFallbackIndex = parseIndexParam(fallbackGoalParam);

      const hasLegacyGoalIndex =
        Number.isInteger(parsedGoalIndex) && parsedGoalIndex >= 0 && parsedGoalIndex < baseGoalsData.length;
      const hasFallbackGoalIndex =
        Number.isInteger(parsedFallbackIndex) && parsedFallbackIndex >= 0 && parsedFallbackIndex < baseGoalsData.length;

      let fallbackGoalIndex = hasFallbackGoalIndex ? parsedFallbackIndex : hasLegacyGoalIndex ? parsedGoalIndex : null;
      const goalIdentifier =
        typeof goalParam === 'string' && goalParam.trim() && !/^\d+$/.test(goalParam.trim())
          ? goalParam.trim()
          : null;

      let currentGoal = null;
      let currentUserId = null;
      let noteSearchQuery = '';
      let activeModalCount = 0;
      let milestoneFormIsOpen = false;
      let milestoneEditIndex = null;

      const mapDatabaseTodo = (todo, index = 0, { fallbackMilestoneId } = {}) => ({
        id: todo?.id ?? null,
        milestoneId: todo?.milestone_id ?? todo?.milestoneId ?? fallbackMilestoneId ?? null,
        title: todo?.title ?? '',
        detail: todo?.detail ?? '',
        completed: Boolean(todo?.completed),
        position: typeof todo?.position === 'number' ? todo.position : index
      });

      const mapDatabaseMilestone = (milestone, index = 0, { fallbackGoalId } = {}) => {
        const mapped = {
          id: milestone?.id ?? null,
          goalId: milestone?.goal_id ?? milestone?.goalId ?? fallbackGoalId ?? null,
          title: milestone?.title ?? '',
          detail: milestone?.detail ?? '',
          completed: Boolean(milestone?.completed),
          progress: milestone?.progress ?? null,
          deadline: milestone?.deadline ?? '',
          position: typeof milestone?.position === 'number' ? milestone.position : index,
          isExpanded: typeof milestone?.isExpanded === 'boolean' ? milestone.isExpanded : false,
          isTodoFormOpen: Boolean(milestone?.isTodoFormOpen),
          shouldFocusTodoTitle: Boolean(milestone?.shouldFocusTodoTitle),
          todos: []
        };

        const todosSource = Array.isArray(milestone?.goal_milestone_todos)
          ? milestone.goal_milestone_todos
          : Array.isArray(milestone?.todos)
            ? milestone.todos
            : [];

        mapped.todos = todosSource.map((todo, todoIndex) => {
          const mappedTodo = mapDatabaseTodo(todo, todoIndex, { fallbackMilestoneId: mapped.id });
          if (!mappedTodo.milestoneId && mapped.id) {
            mappedTodo.milestoneId = mapped.id;
          }
          return mappedTodo;
        });

        return mapped;
      };

      const mapDatabaseGoal = (goal) => {
        const milestoneSource = Array.isArray(goal?.milestones)
          ? goal.milestones
          : Array.isArray(goal?.goal_milestones)
            ? goal.goal_milestones
            : [];

        return {
          id: goal?.id ?? null,
          title: goal?.title ?? '',
          why: goal?.why ?? '',
          deadline: goal?.deadline ?? '',
          status: goal?.status ?? '0%',
          image: goal?.image ?? '',
          category: goal?.category ?? '',
          important: goal?.important ?? '',
          milestones: milestoneSource.map((milestone, index) =>
            mapDatabaseMilestone(milestone, index, { fallbackGoalId: goal?.id ?? null })
          ),
          notes: Array.isArray(goal?.notes) ? goal.notes : [],
          todos: Array.isArray(goal?.todos) ? goal.todos : []
        };
      };

      const getGoalDomIdentifier = () => {
        if (currentGoal?.id) {
          return currentGoal.id;
        }

        if (fallbackGoalIndex !== null) {
          return fallbackGoalIndex;
        }

        return 'x';
      };

      const lockBodyScroll = () => {
        activeModalCount += 1;
        if (activeModalCount === 1) {
          document.body.style.overflow = 'hidden';
        }
      };

      const unlockBodyScroll = () => {
        activeModalCount = Math.max(0, activeModalCount - 1);
        if (activeModalCount === 0) {
          document.body.style.overflow = '';
        }
      };

      const setMilestoneFormVisibility = (isVisible, { focusField = false } = {}) => {
        milestoneFormIsOpen = Boolean(isVisible);

        if (milestoneForm) {
          if (milestoneFormIsOpen) {
            milestoneForm.removeAttribute('hidden');
          } else {
            milestoneForm.setAttribute('hidden', '');
            milestoneForm.reset();
          }
        }

        if (milestoneFormToggle) {
          milestoneFormToggle.setAttribute('aria-expanded', milestoneFormIsOpen ? 'true' : 'false');
          milestoneFormToggle.dataset.state = milestoneFormIsOpen ? 'open' : 'closed';
          const srText = milestoneFormIsOpen ? 'Lukk skjema for ny milepæl' : 'Legg til milepæl';
          setButtonIconContent(milestoneFormToggle, milestoneFormIsOpen ? 'close' : 'plus', srText);
        }

        if (milestoneFormIsOpen && focusField && milestoneForm) {
          requestAnimationFrame(() => {
            milestoneForm['milestone-title']?.focus();
          });
        }
      };

      const formatLongDeadline = (deadline) => {
        if (!deadline) {
          return 'Ingen deadline';
        }

        const date = new Date(deadline);
        if (Number.isNaN(date.getTime())) {
          return deadline;
        }

        return new Intl.DateTimeFormat('nb-NO', {
          day: '2-digit',
          month: 'long',
          year: 'numeric'
        }).format(date);
      };

      const formatShortDeadline = (deadline) => {
        if (!deadline) {
          return '';
        }

        const date = new Date(deadline);
        if (Number.isNaN(date.getTime())) {
          return String(deadline);
        }

        return new Intl.DateTimeFormat('nb-NO', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        }).format(date);
      };

      const formatDateForInput = (value) => {
        if (!value) {
          return '';
        }

        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return '';
        }

        return date.toISOString().slice(0, 10);
      };

      function ensureGoalCollections(goal) {
        if (!goal) {
          return;
        }

        if (!Array.isArray(goal.milestones)) {
          goal.milestones = [];
        }

        if (Array.isArray(goal.todos) && goal.todos.length) {
          const [firstMilestone] = goal.milestones;
          if (firstMilestone && Array.isArray(firstMilestone.todos)) {
            firstMilestone.todos.push(...goal.todos);
          } else if (firstMilestone) {
            firstMilestone.todos = [...goal.todos];
          } else {
            goal.milestones.push({
              title: 'Oppgaver',
              detail: '',
              completed: false,
              todos: [...goal.todos]
            });
          }
          goal.todos = [];
        }

        goal.milestones.forEach((milestone, index) => {
          if (!milestone || typeof milestone !== 'object') {
            goal.milestones[index] = {
              title: '',
              detail: '',
              completed: false,
              todos: [],
              isExpanded: false,
              isTodoFormOpen: false,
              shouldFocusTodoTitle: false
            };
            return;
          }

          if (!Array.isArray(milestone.todos)) {
            milestone.todos = [];
          }

          milestone.todos = milestone.todos.map((todo, todoIndex) => {
            const mappedTodo = mapDatabaseTodo(todo, todoIndex, { fallbackMilestoneId: milestone.id ?? null });
            if (typeof mappedTodo.position !== 'number') {
              mappedTodo.position = todoIndex;
            }
            return mappedTodo;
          });

          if (typeof milestone.position !== 'number') {
            milestone.position = index;
          }

          if (typeof milestone.deadline !== 'string') {
            milestone.deadline = milestone.deadline ? String(milestone.deadline) : '';
          }

          if (typeof milestone.deadline === 'string') {
            milestone.deadline = milestone.deadline.trim();
          }

          if (typeof milestone.isExpanded !== 'boolean') {
            milestone.isExpanded = false;
          }

          if (typeof milestone.isTodoFormOpen !== 'boolean') {
            milestone.isTodoFormOpen = false;
          }

          if (typeof milestone.shouldFocusTodoTitle !== 'boolean') {
            milestone.shouldFocusTodoTitle = false;
          }
        });

        if (!Array.isArray(goal.notes)) {
          goal.notes = [];
        }
      }

      async function loadGoalFromDatabase(goalId) {
        if (!goalId || !currentUserId) {
          return null;
        }

        try {
          const { data, error } = await supabaseClient
            .from('goals')
            .select(`
              id,
              title,
              why,
              deadline,
              image,
              status,
              category,
              important,
              goal_milestones (
                id,
                goal_id,
                title,
                detail,
                completed,
                progress,
                position,
                deadline,
                goal_milestone_todos (
                  id,
                  milestone_id,
                  title,
                  detail,
                  completed,
                  position
                )
              )
            `)
            .eq('user_id', currentUserId)
            .eq('id', goalId)
            .order('position', { ascending: true, foreignTable: 'goal_milestones' })
            .order('position', { ascending: true, foreignTable: 'goal_milestones.goal_milestone_todos' })
            .maybeSingle();

          if (error) {
            throw error;
          }

          if (!data) {
            return null;
          }

          return mapDatabaseGoal(data);
        } catch (loadError) {
          console.error('Feil ved henting av mål fra databasen', loadError);
          return null;
        }
      }

      async function insertMilestoneIntoDatabase(goal, { title, detail, position, deadline }) {
        if (!currentUserId || !goal?.id) {
          return null;
        }

        const payload = {
          goal_id: goal.id,
          title,
          detail: detail ? detail : null,
          completed: false,
          position,
          deadline: deadline ? deadline : null
        };

        const { data, error } = await supabaseClient
          .from('goal_milestones')
          .insert(payload)
          .select('id, goal_id, title, detail, completed, progress, position, deadline')
          .single();

        if (error) {
          throw error;
        }

        return data;
      }

      async function updateMilestoneInDatabase(milestone, updates) {
        if (!currentUserId || !milestone?.id) {
          return null;
        }

        const payload = {
          title: updates.title,
          detail: updates.detail ?? null,
          deadline: updates.deadline ?? null
        };

        const filtered = Object.fromEntries(
          Object.entries(payload).filter(([, value]) => value !== undefined)
        );

        if (!Object.keys(filtered).length) {
          return null;
        }

        const { data, error } = await supabaseClient
          .from('goal_milestones')
          .update(filtered)
          .eq('id', milestone.id)
          .select('id, goal_id, title, detail, completed, progress, position, deadline')
          .single();

        if (error) {
          throw error;
        }

        return data;
      }

      async function insertTodoIntoDatabase(goal, milestone, { title, detail, position }) {
        if (!currentUserId || !goal?.id || !milestone?.id) {
          return null;
        }

        const payload = {
          milestone_id: milestone.id,
          title,
          detail: detail ? detail : null,
          completed: false,
          position
        };

        const { data, error } = await supabaseClient
          .from('goal_milestone_todos')
          .insert(payload)
          .select('id, milestone_id, title, detail, completed, position')
          .single();

        if (error) {
          throw error;
        }

        return data;
      }

      async function updateTodoCompletionInDatabase(todo, completed) {
        if (!currentUserId || !todo?.id) {
          return;
        }

        const query = supabaseClient
          .from('goal_milestone_todos')
          .update({ completed })
          .eq('id', todo.id);

        if (todo.milestoneId) {
          query.eq('milestone_id', todo.milestoneId);
        }

        const { error } = await query;

        if (error) {
          throw error;
        }
      }

      async function deleteTodoFromDatabase(todo) {
        if (!currentUserId || !todo?.id) {
          return;
        }

        const query = supabaseClient.from('goal_milestone_todos').delete().eq('id', todo.id);

        if (todo.milestoneId) {
          query.eq('milestone_id', todo.milestoneId);
        }

        const { error } = await query;

        if (error) {
          throw error;
        }
      }

      async function persistMilestoneOrder(goal) {
        if (!currentUserId || !goal?.id) {
          return;
        }

        const updates = goal.milestones
          .filter((milestone) => milestone?.id)
          .map((milestone, index) =>
            supabaseClient
              .from('goal_milestones')
              .update({ position: index })
              .eq('id', milestone.id)
              .eq('goal_id', goal.id)
          );

        if (!updates.length) {
          return;
        }

        const responses = await Promise.all(updates);
        const failed = responses.find((response) => response?.error);
        if (failed?.error) {
          throw failed.error;
        }
      }

      async function persistTodoOrder(goal, milestone) {
        if (!currentUserId || !goal?.id || !milestone?.id) {
          return;
        }

        const updates = milestone.todos
          .filter((todo) => todo?.id)
          .map((todo, index) =>
            supabaseClient
              .from('goal_milestone_todos')
              .update({ position: index })
              .eq('id', todo.id)
              .eq('milestone_id', milestone.id)
          );

        if (!updates.length) {
          return;
        }

        const responses = await Promise.all(updates);
        const failed = responses.find((response) => response?.error);
        if (failed?.error) {
          throw failed.error;
        }
      }

      const reorderWithDrag = (items, fromIndex, toIndex, placeBefore) => {
        const updated = Array.from(items);
        const [moved] = updated.splice(fromIndex, 1);

        if (placeBefore) {
          let insertIndex = toIndex;
          if (fromIndex < toIndex) {
            insertIndex -= 1;
          }
          updated.splice(insertIndex < 0 ? 0 : insertIndex, 0, moved);
        } else {
          let insertIndex = toIndex;
          if (fromIndex > toIndex) {
            insertIndex += 1;
          }
          updated.splice(insertIndex, 0, moved);
        }

        return updated;
      };

      function setupDragAndDrop(listElement, items, onReorder) {
        if (!listElement || !Array.isArray(items) || items.length === 0) {
          listElement.ondragover = null;
          listElement.ondrop = null;
          return;
        }

        const handleListDragOver = (event) => {
          event.preventDefault();
          event.dataTransfer.dropEffect = 'move';
        };

        const handleListDrop = (event) => {
          if (event.target.closest('[data-draggable-index]')) {
            return;
          }

          event.preventDefault();
          const sourceIndex = Number.parseInt(event.dataTransfer.getData('text/plain'), 10);
          if (Number.isNaN(sourceIndex)) {
            return;
          }

          const updated = Array.from(items);
          const [moved] = updated.splice(sourceIndex, 1);
          updated.push(moved);
          onReorder(updated);
        };

        listElement.ondragover = handleListDragOver;
        listElement.ondrop = handleListDrop;

        Array.from(listElement.children).forEach((child) => {
          const handleDragStart = (event) => {
            const index = Number.parseInt(child.dataset.draggableIndex || '-1', 10);
            if (Number.isNaN(index)) {
              return;
            }
            child.classList.add('is-dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', String(index));
          };

          const handleDragEnd = () => {
            child.classList.remove('is-dragging');
            child.classList.remove('is-drag-over');
            child.style.removeProperty('--drop-indicator');
          };

          const handleDragOver = (event) => {
            event.preventDefault();
            const draggingIndex = Number.parseInt(event.dataTransfer.getData('text/plain'), 10);
            const currentIndex = Number.parseInt(child.dataset.draggableIndex || '-1', 10);
            if (Number.isNaN(draggingIndex) || Number.isNaN(currentIndex) || draggingIndex === currentIndex) {
              return;
            }
            const rect = child.getBoundingClientRect();
            const dropBefore = event.clientY < rect.top + rect.height / 2;
            child.classList.add('is-drag-over');
            child.style.setProperty('--drop-indicator', dropBefore ? '0%' : '100%');
            event.dataTransfer.dropEffect = 'move';
          };

          const handleDragLeave = () => {
            child.classList.remove('is-drag-over');
            child.style.removeProperty('--drop-indicator');
          };

          const handleDrop = (event) => {
            event.preventDefault();
            const sourceIndex = Number.parseInt(event.dataTransfer.getData('text/plain'), 10);
            const targetIndex = Number.parseInt(child.dataset.draggableIndex || '-1', 10);
            if (Number.isNaN(sourceIndex) || Number.isNaN(targetIndex) || sourceIndex === targetIndex) {
              child.classList.remove('is-drag-over');
              child.style.removeProperty('--drop-indicator');
              return;
            }

            const rect = child.getBoundingClientRect();
            const dropBefore = event.clientY < rect.top + rect.height / 2;
            const updated = reorderWithDrag(items, sourceIndex, targetIndex, dropBefore);
            child.classList.remove('is-drag-over');
            child.style.removeProperty('--drop-indicator');
            onReorder(updated);
          };

          child.addEventListener('dragstart', handleDragStart);
          child.addEventListener('dragend', handleDragEnd);
          child.addEventListener('dragover', handleDragOver);
          child.addEventListener('dragleave', handleDragLeave);
          child.addEventListener('drop', handleDrop);
      });
    }

    function reorderTodosAfterCompletion(milestone, todo) {
      if (!milestone || typeof milestone !== 'object' || !Array.isArray(milestone.todos) || !todo) {
        return;
      }

      const todos = milestone.todos;
      const currentIndex = todos.indexOf(todo);
      if (currentIndex === -1) {
        return;
      }

      todos.splice(currentIndex, 1);

      if (todo.completed) {
        let insertIndex = todos.findIndex((item) => item && item.completed);
        if (insertIndex === -1) {
          insertIndex = todos.length;
        }
        todos.splice(insertIndex, 0, todo);
      } else {
        const firstCompletedIndex = todos.findIndex((item) => item && item.completed);
        const insertIndex = firstCompletedIndex === -1 ? todos.length : firstCompletedIndex;
        todos.splice(insertIndex, 0, todo);
      }

      todos.forEach((todoItem, index) => {
        if (todoItem) {
          todoItem.position = index;
        }
      });
    }

    function updateMilestoneToggleAllButton(goal) {
      if (!milestoneToggleAllButton) {
        return;
      }

        const hasMilestones = Array.isArray(goal.milestones) && goal.milestones.length > 0;
        milestoneToggleAllButton.disabled = !hasMilestones;

        if (!hasMilestones) {
          milestoneToggleAllButton.setAttribute('aria-pressed', 'false');
          milestoneToggleAllButton.dataset.state = 'closed';
          setButtonIconContent(
            milestoneToggleAllButton,
            'chevronsDown',
            'Ingen milepæler tilgjengelig'
          );
          return;
        }

        const allCollapsed = goal.milestones.every((milestone) => !Boolean(milestone.isExpanded));
        const srText = allCollapsed ? 'Vis alle milepæl to-dos' : 'Skjul alle milepæl to-dos';
        milestoneToggleAllButton.dataset.state = allCollapsed ? 'closed' : 'open';
        setButtonIconContent(
          milestoneToggleAllButton,
          allCollapsed ? 'chevronsDown' : 'chevronsUp',
          srText
        );
        milestoneToggleAllButton.setAttribute('aria-pressed', allCollapsed ? 'true' : 'false');
      }

      function toggleMilestoneTodos(goal, milestoneIndex) {
        if (!goal || !Array.isArray(goal.milestones)) {
          return;
        }

        ensureGoalCollections(goal);
        const milestone = goal.milestones[milestoneIndex];
        if (!milestone || typeof milestone !== 'object') {
          return;
        }

        milestone.isExpanded = !Boolean(milestone.isExpanded);
        renderMilestones(goal);
      }

      function setAllMilestoneTodos(goal, shouldExpand) {
        if (!goal || !Array.isArray(goal.milestones)) {
          return;
        }

        ensureGoalCollections(goal);
        goal.milestones.forEach((milestone) => {
          if (!milestone || typeof milestone !== 'object') {
            return;
          }

          milestone.isExpanded = shouldExpand ? true : false;
        });

        renderMilestones(goal);
      }

      function createMilestoneStatusIndicator(todos) {
        const todosArray = Array.isArray(todos) ? todos : [];
        const totalCount = todosArray.length;
        const completedCount = todosArray.filter((todo) => Boolean(todo?.completed)).length;
        const statusDescription = totalCount
          ? `${completedCount} av ${totalCount} to-dos fullført`
          : 'Ingen to-dos registrert';

        const indicator = document.createElement('div');
        indicator.className = 'goal-milestone__status';
        indicator.title = statusDescription;

        const ring = document.createElement('div');
        ring.className = 'goal-milestone__status-ring';
        let progressDegrees = 0;
        if (totalCount > 0) {
          const progressFraction = completedCount / totalCount;
          progressDegrees = Math.max(0, Math.min(359.9, progressFraction * 360));
          if (completedCount === totalCount) {
            ring.style.setProperty('--goal-status-color', '#16a34a');
          }
        }
        ring.style.setProperty('--goal-status-degree', `${progressDegrees}deg`);

        const countSpan = document.createElement('span');
        countSpan.className = 'goal-milestone__status-count';
        countSpan.textContent = `${completedCount}/${totalCount || 0}`;
        countSpan.setAttribute('aria-hidden', 'true');
        ring.appendChild(countSpan);

        const srText = document.createElement('span');
        srText.className = 'goal-sr-only';
        srText.textContent = statusDescription;
        indicator.appendChild(srText);

        indicator.appendChild(ring);

        const label = document.createElement('span');
        label.className = 'goal-milestone__status-label';
        label.textContent = 'fullført';
        label.setAttribute('aria-hidden', 'true');
        indicator.appendChild(label);

        return indicator;
      }

      function renderMilestones(goal) {
        if (!milestoneList) {
          return;
        }

        milestoneList.innerHTML = '';
        ensureGoalCollections(goal);

        const goalDomIdentifier = goal?.id ?? getGoalDomIdentifier();

        updateMilestoneToggleAllButton(goal);

        if (!goal.milestones.length) {
          const emptyItem = document.createElement('li');
          emptyItem.className = 'empty-state';
          emptyItem.textContent = 'Legg til milepælene dine her.';
          milestoneList.appendChild(emptyItem);
          milestoneList.ondragover = null;
          milestoneList.ondrop = null;
          return;
        }

        goal.milestones.forEach((milestone, index) => {
          const item = document.createElement('li');
          item.className = 'goal-list__item goal-milestone';
          item.draggable = true;
          item.dataset.draggableIndex = String(index);
          item.dataset.completed = milestone.completed ? 'true' : 'false';

          const todosContainerId = `goal-milestone-${index}-todos`;
          const todos = Array.isArray(milestone.todos) ? milestone.todos : [];

          if (milestone.progress) {
            item.dataset.progress = milestone.progress;
          } else {
            item.removeAttribute('data-progress');
          }

          const header = document.createElement('div');
          header.className = 'goal-milestone__header';

          const label = document.createElement('div');
          label.className = 'goal-list__label';

          const titleSpan = document.createElement('span');
          titleSpan.textContent = milestone.title;
          label.appendChild(titleSpan);

          if (milestone.detail) {
            const detailSpan = document.createElement('span');
            detailSpan.textContent = milestone.detail;
            label.appendChild(detailSpan);
          }

          const formattedMilestoneDeadline = formatShortDeadline(milestone.deadline);
          if (formattedMilestoneDeadline) {
            const deadlineSpan = document.createElement('span');
            deadlineSpan.className = 'goal-milestone__deadline';
            deadlineSpan.textContent = `Deadline: ${formattedMilestoneDeadline}`;
            label.appendChild(deadlineSpan);
          }

          const info = document.createElement('div');
          info.className = 'goal-milestone__info';
          const statusIndicator = createMilestoneStatusIndicator(todos);
          info.appendChild(statusIndicator);
          info.appendChild(label);

          header.appendChild(info);

          const actions = document.createElement('div');
          actions.className = 'goal-milestone__actions';

          const trimmedTitle = (milestone.title || '').trim();
          const editButton = document.createElement('button');
          editButton.type = 'button';
          editButton.className = 'goal-icon-button goal-milestone__edit';
          editButton.dataset.milestoneIndex = String(index);
          const editLabel = trimmedTitle ? `Rediger milepælen ${trimmedTitle}` : 'Rediger milepælen';
          editButton.setAttribute('aria-label', editLabel);
          editButton.title = editLabel;
          setButtonIconContent(editButton, 'pencil', editLabel);
          editButton.addEventListener('click', () => {
            openMilestoneEditModal(goal, index);
          });

          const isExpanded = Boolean(milestone.isExpanded);
          const toggleButton = document.createElement('button');
          toggleButton.type = 'button';
          toggleButton.className = 'goal-icon-button goal-milestone__toggle';
          toggleButton.dataset.state = isExpanded ? 'open' : 'closed';
          toggleButton.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
          toggleButton.setAttribute('aria-controls', todosContainerId);
          const toggleSrText = isExpanded
            ? trimmedTitle
              ? `Skjul to-dos for milepælen ${trimmedTitle}`
              : 'Skjul to-dos for denne milepælen'
            : trimmedTitle
              ? `Vis to-dos for milepælen ${trimmedTitle}`
              : 'Vis to-dos for denne milepælen';
          setButtonIconContent(toggleButton, isExpanded ? 'chevronsUp' : 'chevronsDown', toggleSrText);
          toggleButton.addEventListener('click', () => {
            toggleMilestoneTodos(goal, index);
          });

          const isTodoFormOpen = Boolean(milestone.isTodoFormOpen);
          const todoAddButton = document.createElement('button');
          todoAddButton.type = 'button';
          todoAddButton.className = 'goal-icon-button goal-milestone__todo-add';
          todoAddButton.dataset.state = isTodoFormOpen ? 'open' : 'closed';
          todoAddButton.setAttribute('aria-expanded', isTodoFormOpen ? 'true' : 'false');
          const addSrText = isTodoFormOpen
            ? trimmedTitle
              ? `Lukk skjema for ny to-do i milepælen ${trimmedTitle}`
              : 'Lukk skjema for ny to-do'
            : trimmedTitle
              ? `Legg til ny to-do i milepælen ${trimmedTitle}`
              : 'Legg til ny to-do';
          setButtonIconContent(todoAddButton, isTodoFormOpen ? 'close' : 'plus', addSrText);
          todoAddButton.addEventListener('click', () => {
            const shouldOpen = !Boolean(milestone.isTodoFormOpen);
            milestone.isTodoFormOpen = shouldOpen;
            if (shouldOpen) {
              milestone.shouldFocusTodoTitle = true;
            }
            renderMilestones(goal);
          });

          actions.appendChild(editButton);
          actions.appendChild(toggleButton);
          actions.appendChild(todoAddButton);

          header.appendChild(actions);

          item.appendChild(header);

          const todosContainer = document.createElement('div');
          todosContainer.className = 'goal-milestone__todos';
          todosContainer.id = todosContainerId;
          todosContainer.hidden = !isExpanded;

          const todoContent = document.createElement('div');
          todoContent.className = 'goal-milestone__todo-content';
          todosContainer.appendChild(todoContent);

          const todoListElement = document.createElement('ul');
          todoListElement.className = 'goal-milestone__todo-list';
          todoContent.appendChild(todoListElement);

          if (!todos.length) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.textContent = 'Ingen to-dos knyttet til denne milepælen ennå.';
            todoContent.appendChild(emptyState);
          } else {
            todos.forEach((todo, todoIndex) => {
              const todoItem = document.createElement('li');
              todoItem.className = 'goal-list__item goal-milestone__todo-item';
              todoItem.draggable = true;
              todoItem.dataset.draggableIndex = String(todoIndex);
              todoItem.dataset.completed = todo.completed ? 'true' : 'false';

              const todoWrapper = document.createElement('div');
              todoWrapper.className = 'goal-list__todo';

              const todoMain = document.createElement('div');
              todoMain.className = 'goal-list__todo-main';

              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              const checkboxId = `goal-${goalDomIdentifier}-milestone-${index}-todo-${todoIndex}`;
              checkbox.id = checkboxId;
              checkbox.checked = Boolean(todo.completed);
              checkbox.addEventListener('click', (event) => {
                event.stopPropagation();
              });
              checkbox.addEventListener('change', async () => {
                const newValue = checkbox.checked;
                const previousValue = Boolean(todo.completed);
                if (newValue === previousValue) {
                  return;
                }

                const previousTodos = milestone.todos.slice();
                const previousPositions = previousTodos.map((todoItem) =>
                  typeof todoItem.position === 'number' ? todoItem.position : null
                );
                const previousCompletionStates = previousTodos.map((todoItem) => Boolean(todoItem.completed));

                todo.completed = newValue;
                reorderTodosAfterCompletion(milestone, todo);
                renderMilestones(goal);
                try {
                  await updateTodoCompletionInDatabase(todo, newValue);
                  await persistTodoOrder(goal, milestone);
                } catch (completionError) {
                  console.error('Feil ved oppdatering av to-do', completionError);
                  todo.completed = previousValue;
                  milestone.todos = previousTodos;
                  milestone.todos.forEach((todoItem, idx) => {
                    todoItem.position = previousPositions[idx] ?? idx;
                    todoItem.completed = previousCompletionStates[idx];
                  });
                  renderMilestones(goal);
                }
              });

              const todoLabel = document.createElement('label');
              todoLabel.setAttribute('for', checkboxId);

              const todoTitleSpan = document.createElement('span');
              todoTitleSpan.className = 'goal-list__todo-title';
              todoTitleSpan.textContent = todo.title;
              todoLabel.appendChild(todoTitleSpan);

              todoMain.appendChild(checkbox);
              todoMain.appendChild(todoLabel);

              const todoActions = document.createElement('div');
              todoActions.className = 'goal-list__todo-actions';

              const deleteButton = document.createElement('button');
              deleteButton.type = 'button';
              deleteButton.className = 'goal-milestone__todo-delete';
              const todoTitleTrimmed = (todo.title || '').trim();
              const deleteLabel = todoTitleTrimmed ? `Slett to-do ${todoTitleTrimmed}` : 'Slett to-do';
              setButtonIconContent(deleteButton, 'x', deleteLabel);
              deleteButton.addEventListener('click', async (event) => {
                event.stopPropagation();
                const previousTodos = milestone.todos.slice();
                const previousPositions = previousTodos.map((todoItem) =>
                  typeof todoItem.position === 'number' ? todoItem.position : null
                );
                const previousCompletionStates = previousTodos.map((todoItem) => Boolean(todoItem.completed));
                const currentIndex = milestone.todos.indexOf(todo);
                if (currentIndex === -1) {
                  return;
                }

                milestone.todos.splice(currentIndex, 1);
                milestone.todos.forEach((todoItem, updatedIndex) => {
                  todoItem.position = updatedIndex;
                });
                renderMilestones(goal);

                try {
                  if (todo.id) {
                    await deleteTodoFromDatabase(todo);
                  }
                  await persistTodoOrder(goal, milestone);
                } catch (deleteError) {
                  console.error('Feil ved sletting av to-do', deleteError);
                  milestone.todos = previousTodos;
                  milestone.todos.forEach((todoItem, idx) => {
                    todoItem.position = previousPositions[idx] ?? idx;
                    todoItem.completed = previousCompletionStates[idx];
                  });
                  renderMilestones(goal);
                }
              });

              todoActions.appendChild(deleteButton);

              todoWrapper.appendChild(todoMain);
              todoWrapper.appendChild(todoActions);
              todoItem.appendChild(todoWrapper);
              todoListElement.appendChild(todoItem);
            });

            setupDragAndDrop(todoListElement, todos, async (updated) => {
              milestone.todos = updated;
              milestone.todos.forEach((todoItem, updatedIndex) => {
                todoItem.position = updatedIndex;
              });
              renderMilestones(goal);
              try {
                await persistTodoOrder(goal, milestone);
              } catch (orderError) {
                console.error('Feil ved lagring av rekkefølge for to-dos', orderError);
              }
            });
          }

          const todoForm = document.createElement('form');
          todoForm.className = 'goal-milestone__todo-form';
          if (!isTodoFormOpen) {
            todoForm.setAttribute('hidden', '');
          }

          const todoTitleInput = document.createElement('input');
          todoTitleInput.type = 'text';
          todoTitleInput.name = 'todo-title';
          todoTitleInput.placeholder = 'Legg til to-do';
          todoTitleInput.required = true;

          const todoSubmit = document.createElement('button');
          todoSubmit.type = 'submit';
          todoSubmit.innerHTML = '<span aria-hidden="true">+</span><span class="goal-sr-only">Legg til to-do</span>';

          todoForm.appendChild(todoTitleInput);
          todoForm.appendChild(todoSubmit);

          if (isTodoFormOpen && milestone.shouldFocusTodoTitle) {
            requestAnimationFrame(() => {
              todoTitleInput.focus();
            });
            milestone.shouldFocusTodoTitle = false;
          }

          todoForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const titleValue = todoTitleInput.value.trim();
            if (!titleValue) {
              return;
            }

            const position = 0;
            const newTodo = {
              title: titleValue,
              detail: '',
              completed: false,
              milestoneId: milestone.id ?? null,
              id: null,
              position
            };

            milestone.todos.unshift(newTodo);
            milestone.todos.forEach((todoItem, updatedIndex) => {
              todoItem.position = updatedIndex;
            });
            milestone.isExpanded = true;

            todoForm.reset();
            milestone.isTodoFormOpen = false;
            milestone.shouldFocusTodoTitle = false;
            renderMilestones(goal);

            if (currentGoal?.id && milestone.id) {
              try {
                const insertedTodo = await insertTodoIntoDatabase(currentGoal, milestone, {
                  title: titleValue,
                  detail: '',
                  position
                });
                if (insertedTodo) {
                  const mappedTodo = mapDatabaseTodo(insertedTodo, position, { fallbackMilestoneId: milestone.id });
                  milestone.todos[0] = { ...milestone.todos[0], ...mappedTodo };
                  milestone.todos.forEach((todoItem, updatedIndex) => {
                    todoItem.position = updatedIndex;
                  });
                  renderMilestones(goal);
                }
                try {
                  await persistTodoOrder(goal, milestone);
                } catch (orderError) {
                  console.error('Feil ved lagring av rekkefølge for to-dos', orderError);
                }
              } catch (todoError) {
                console.error('Feil ved lagring av to-do', todoError);
                milestone.todos.shift();
                milestone.todos.forEach((todoItem, updatedIndex) => {
                  todoItem.position = updatedIndex;
                });
                renderMilestones(goal);
              }
            }
          });

          todosContainer.insertBefore(todoForm, todosContainer.firstChild);
          item.appendChild(todosContainer);
          milestoneList.appendChild(item);
        });

        setupDragAndDrop(milestoneList, goal.milestones, async (updated) => {
          goal.milestones = updated;
          goal.milestones.forEach((milestoneItem, milestoneIndex) => {
            milestoneItem.position = milestoneIndex;
          });
          renderMilestones(goal);
          try {
            await persistMilestoneOrder(goal);
          } catch (orderError) {
            console.error('Feil ved lagring av rekkefølge for milepæler', orderError);
          }
        });
      }

      if (milestoneToggleAllButton) {
        milestoneToggleAllButton.addEventListener('click', () => {
          if (!currentGoal) {
            return;
          }

          ensureGoalCollections(currentGoal);
          const allCollapsed = currentGoal.milestones.every((milestone) => !Boolean(milestone.isExpanded));
          setAllMilestoneTodos(currentGoal, allCollapsed);
        });
      }

      function renderNotes(goal) {
        if (!notesList) {
          return;
        }

        notesList.innerHTML = '';
        ensureGoalCollections(goal);

        if (notesSearchInput) {
          notesSearchInput.value = noteSearchQuery;
        }

        const query = noteSearchQuery.trim().toLowerCase();
        const filteredNotes = goal.notes
          .map((note, index) => ({ note, index }))
          .filter(({ note }) => {
            if (!query) {
              return true;
            }

            const searchableText = `${note.title || ''} ${note.content || ''}`.toLowerCase();
            return searchableText.includes(query);
          });

        if (!filteredNotes.length) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = query
            ? 'Ingen notater matcher søket ditt.'
            : 'Ingen notater ennå. Skriv ned viktige tanker eller ressurser her.';
          notesList.appendChild(empty);
          return;
        }

        filteredNotes.forEach(({ note, index }) => {
          const button = document.createElement('button');
          button.type = 'button';
          button.className = 'goal-note';
          button.dataset.noteIndex = String(index);

          const heading = document.createElement('h4');
          heading.textContent = note.title;
          button.appendChild(heading);

          if (note.content) {
            const preview = document.createElement('p');
            const trimmedContent = note.content.trim();
            preview.textContent = trimmedContent.length > 120
              ? `${trimmedContent.slice(0, 117)}...`
              : trimmedContent;
            button.appendChild(preview);
          }

          button.addEventListener('click', () => {
            openNoteModal(note);
          });

          notesList.appendChild(button);
        });
      }

      function renderGoalDetail(goal) {
        if (!goalDetailSection) {
          return;
        }

        ensureGoalCollections(goal);
        setMilestoneFormVisibility(false);

        goalDetailTitle.textContent = goal.title || '';
        goalDetailWhy.textContent = goal.description || goal.why || '';
        goalDetailDeadline.textContent = formatLongDeadline(goal.deadline);
        goalDetailCategory.textContent = goal.category || 'Personlig mål';
        goalDetailImportant.textContent = goal.important || goal.why || 'Holder meg motivert';

        const imageSource = goal.image || '';
        if (imageSource) {
          goalDetailImage.src = imageSource;
          goalDetailImage.alt = goal.title ? `Illustrasjon for ${goal.title}` : '';
        } else {
          goalDetailImage.removeAttribute('src');
          goalDetailImage.alt = '';
        }

        renderMilestones(goal);
        renderNotes(goal);
      }

      function openMilestoneEditModal(goal, milestoneIndex) {
        if (!milestoneEditModal || !milestoneEditForm) {
          return;
        }

        ensureGoalCollections(goal);
        const milestone = goal?.milestones?.[milestoneIndex];
        if (!milestone) {
          return;
        }

        milestoneEditIndex = milestoneIndex;

        const titleField = milestoneEditForm['milestone-title'];
        const detailField = milestoneEditForm['milestone-detail'];
        const deadlineField = milestoneEditForm['milestone-deadline'];

        if (titleField) {
          titleField.value = milestone.title || '';
        }

        if (detailField) {
          detailField.value = milestone.detail || '';
        }

        if (deadlineField) {
          deadlineField.value = formatDateForInput(milestone.deadline);
          deadlineField.dataset.originalValue = milestone.deadline || '';
        }

        milestoneEditModal.removeAttribute('hidden');
        milestoneEditModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();

        requestAnimationFrame(() => {
          titleField?.focus();
        });
      }

      function closeMilestoneEditModal({ restoreFocus = true } = {}) {
        if (!milestoneEditModal || !milestoneEditForm) {
          return;
        }

        const previousIndex = milestoneEditIndex;
        milestoneEditIndex = null;

        milestoneEditModal.setAttribute('hidden', '');
        milestoneEditModal.setAttribute('aria-hidden', 'true');
        const editDeadlineField = milestoneEditForm['milestone-deadline'];
        if (editDeadlineField) {
          delete editDeadlineField.dataset.originalValue;
        }
        milestoneEditForm.reset();
        unlockBodyScroll();

        if (restoreFocus && previousIndex !== null && milestoneList) {
          const selector = `.goal-milestone[data-draggable-index="${previousIndex}"] .goal-milestone__edit`;
          const editButton = milestoneList.querySelector(selector);
          editButton?.focus();
        }
      }

      function openNoteModal(note) {
        if (!noteModal) {
          return;
        }

        noteModalTitle.textContent = note.title || 'Notat';
        noteModalContent.textContent = note.content || '';
        noteModal.removeAttribute('hidden');
        noteModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();
        requestAnimationFrame(() => {
          noteModalClose?.focus();
        });
      }

      function closeNoteModal({ restoreFocus = true } = {}) {
        if (!noteModal) {
          return;
        }

        noteModal.setAttribute('hidden', '');
        noteModal.setAttribute('aria-hidden', 'true');
        unlockBodyScroll();

        if (restoreFocus) {
          const firstNoteButton = notesList?.querySelector('.goal-note');
          firstNoteButton?.focus();
        }
      }

      function openNoteCreateModal() {
        if (!noteCreateModal) {
          return;
        }

        noteCreateForm?.reset();
        noteCreateModal.removeAttribute('hidden');
        noteCreateModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();
        requestAnimationFrame(() => {
          const titleField = noteCreateForm?.querySelector('input[name="note-title"]');
          titleField?.focus();
        });
      }

      function closeNoteCreateModal({ restoreFocus = true } = {}) {
        if (!noteCreateModal) {
          return;
        }

        noteCreateModal.setAttribute('hidden', '');
        noteCreateModal.setAttribute('aria-hidden', 'true');
        unlockBodyScroll();
        noteCreateForm?.reset();

        if (restoreFocus) {
          addNoteButton?.focus();
        }
      }

      function showGoalDetail(goal) {
        if (!goalDetailSection) {
          return;
        }

        renderGoalDetail(goal);
        goalDetailSection.removeAttribute('hidden');
        emptyStateSection?.setAttribute('hidden', '');
      }

      function showEmptyState() {
        goalDetailSection?.setAttribute('hidden', '');
        emptyStateSection?.removeAttribute('hidden');
        setMilestoneFormVisibility(false);
      }

      if (goalDetailBackButton) {
        goalDetailBackButton.addEventListener('click', () => {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = 'mal.html';
          }
        });
      }

      if (milestoneEditModal) {
        milestoneEditModal.addEventListener('click', (event) => {
          if (event.target === milestoneEditModal) {
            closeMilestoneEditModal();
          }
        });
      }

      if (milestoneEditClose) {
        milestoneEditClose.addEventListener('click', () => closeMilestoneEditModal());
      }

      if (noteModal) {
        noteModal.addEventListener('click', (event) => {
          if (event.target === noteModal) {
            closeNoteModal();
          }
        });
      }

      if (noteModalClose) {
        noteModalClose.addEventListener('click', () => closeNoteModal());
      }

      if (noteCreateModal) {
        noteCreateModal.addEventListener('click', (event) => {
          if (event.target === noteCreateModal) {
            closeNoteCreateModal();
          }
        });
      }

      if (noteCreateClose) {
        noteCreateClose.addEventListener('click', () => closeNoteCreateModal());
      }

      if (notesSearchInput) {
        notesSearchInput.addEventListener('input', () => {
          noteSearchQuery = notesSearchInput.value;
          if (currentGoal) {
            renderNotes(currentGoal);
          }
        });
      }

      if (addNoteButton) {
        addNoteButton.addEventListener('click', () => openNoteCreateModal());
      }

      if (milestoneFormToggle) {
        milestoneFormToggle.addEventListener('click', () => {
          const shouldOpen = !milestoneFormIsOpen;
          setMilestoneFormVisibility(shouldOpen, { focusField: shouldOpen });
        });
      }

      if (noteCreateForm) {
        noteCreateForm.addEventListener('submit', (event) => {
          event.preventDefault();
          if (!currentGoal) {
            return;
          }

          const titleValue = noteCreateForm['note-title']?.value.trim();
          const contentValue = noteCreateForm['note-content']?.value.trim();

          if (!titleValue || !contentValue) {
            return;
          }

          currentGoal.notes.unshift({
            title: titleValue,
            content: contentValue
          });

          noteSearchQuery = '';
          renderNotes(currentGoal);
          closeNoteCreateModal({ restoreFocus: false });
          requestAnimationFrame(() => {
            const [firstNote] = notesList?.querySelectorAll('.goal-note') || [];
            firstNote?.focus();
          });
        });
      }

      if (milestoneEditForm) {
        milestoneEditForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!currentGoal || milestoneEditIndex === null) {
            return;
          }

          ensureGoalCollections(currentGoal);
          const milestone = currentGoal.milestones[milestoneEditIndex];
          if (!milestone) {
            return;
          }

          const previousTitle = milestone.title;
          const previousDetail = milestone.detail;
          const previousDeadline = milestone.deadline;

          const titleField = milestoneEditForm['milestone-title'];
          const detailField = milestoneEditForm['milestone-detail'];
          const deadlineField = milestoneEditForm['milestone-deadline'];

          const titleValue = titleField?.value.trim();
          const detailValue = detailField?.value.trim();
          const deadlineValue = deadlineField?.value;
          const originalDeadline = deadlineField?.dataset?.originalValue || '';
          const originalWasInvalid = Boolean(originalDeadline) && !formatDateForInput(originalDeadline);

          if (!titleValue) {
            return;
          }

          milestone.title = titleValue;
          milestone.detail = detailValue || '';
          if (deadlineValue) {
            milestone.deadline = deadlineValue;
          } else if (originalWasInvalid) {
            milestone.deadline = originalDeadline;
          } else {
            milestone.deadline = '';
          }
          milestone.isExpanded = true;

          const editedIndex = milestoneEditIndex;

          renderMilestones(currentGoal);
          closeMilestoneEditModal({ restoreFocus: false });

          try {
            if (milestone.id) {
              await updateMilestoneInDatabase(milestone, {
                title: titleValue,
                detail: detailValue || null,
                deadline: milestone.deadline ? milestone.deadline : null
              });
            }
          } catch (milestoneError) {
            console.error('Feil ved oppdatering av milepæl', milestoneError);
            milestone.title = previousTitle;
            milestone.detail = previousDetail;
            milestone.deadline = previousDeadline;
            renderMilestones(currentGoal);
          } finally {
            requestAnimationFrame(() => {
              const selector = `.goal-milestone[data-draggable-index="${editedIndex}"] .goal-milestone__edit`;
              const editButton = milestoneList?.querySelector(selector);
              editButton?.focus();
            });
          }
        });
      }

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (milestoneEditModal && !milestoneEditModal.hasAttribute('hidden')) {
            closeMilestoneEditModal();
          } else if (noteCreateModal && !noteCreateModal.hasAttribute('hidden')) {
            closeNoteCreateModal();
          } else if (noteModal && !noteModal.hasAttribute('hidden')) {
            closeNoteModal();
          }
        }
      });

      if (milestoneForm) {
        milestoneForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!currentGoal) {
            return;
          }

          ensureGoalCollections(currentGoal);
          const titleField = milestoneForm['milestone-title'];
          const detailField = milestoneForm['milestone-detail'];
          const titleValue = titleField?.value.trim();
          const detailValue = detailField?.value.trim();

          if (!titleValue) {
            return;
          }

          const position = 0;
          let insertedMilestone = null;

          if (currentGoal.id) {
            try {
              insertedMilestone = await insertMilestoneIntoDatabase(currentGoal, {
                title: titleValue,
                detail: detailValue,
                position,
                deadline: ''
              });
            } catch (milestoneError) {
              console.error('Feil ved lagring av milepæl', milestoneError);
            }
          }

          const milestonePayload = insertedMilestone ?? {
            goal_id: currentGoal.id ?? null,
            title: titleValue,
            detail: detailValue,
            completed: false,
            deadline: '',
            position
          };

          const newMilestone = mapDatabaseMilestone(milestonePayload, position, {
            fallbackGoalId: currentGoal.id ?? null
          });
          newMilestone.isExpanded = true;
          newMilestone.isTodoFormOpen = false;
          newMilestone.shouldFocusTodoTitle = false;

          currentGoal.milestones.unshift(newMilestone);
          currentGoal.milestones.forEach((milestone, index) => {
            milestone.position = index;
          });

          milestoneForm.reset();
          setMilestoneFormVisibility(false);
          renderMilestones(currentGoal);

          if (currentGoal.id) {
            try {
              await persistMilestoneOrder(currentGoal);
            } catch (orderError) {
              console.error('Feil ved lagring av rekkefølge for milepæler', orderError);
            }
          }
        });
      }

      async function initializeGoal() {
        try {
          const { data, error } = await supabaseClient.auth.getSession();

          if (error) {
            throw error;
          }

          if (!data?.session) {
            window.location.replace('login.html');
            return;
          }

          currentUserId = data.session.user.id;
        } catch (authError) {
          console.error('Feil ved henting av sesjon', authError);
          window.location.replace('login.html');
          return;
        }

        if (goalIdentifier) {
          const loadedGoal = await loadGoalFromDatabase(goalIdentifier);
          if (loadedGoal) {
            currentGoal = loadedGoal;
            fallbackGoalIndex = null;
          }
        }

        if (!currentGoal && fallbackGoalIndex !== null) {
          const fallbackGoal = baseGoalsData[fallbackGoalIndex];
          if (fallbackGoal) {
            currentGoal = cloneGoal(fallbackGoal);
          }
        }

        if (currentGoal) {
          ensureGoalCollections(currentGoal);
        }
      }

      await initializeGoal();

      if (currentGoal) {
        showGoalDetail(currentGoal);
      } else {
        showEmptyState();
      }
    })();
  </script>
</body>
</html>
