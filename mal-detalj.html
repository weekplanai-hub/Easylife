<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mål · Detaljer · Easylife</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --sidebar-bg: linear-gradient(180deg, #101828 0%, #020617 100%);
      --sidebar-width: 260px;
      --card-bg: rgba(255, 255, 255, 0.08);
      --text-primary: #0f1c2e;
      --text-secondary: rgba(15, 28, 46, 0.64);
      --surface: rgba(255, 255, 255, 0.55);
      --surface-border: rgba(255, 255, 255, 0.35);
      --chip-bg: rgba(15, 28, 46, 0.55);
    }

    * { box-sizing: border-box; }

    /* Sørg for at hidden-attributtet alltid skjuler elementer */
    [hidden] {
      display: none !important;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(120% 120% at 10% 0%, rgba(201, 226, 255, 0.9) 0%, rgba(228, 241, 255, 0.9) 45%, rgba(196, 215, 238, 0.95) 100%), #f1f5f9;
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
    }

    .sidebar {
      width: var(--sidebar-width);
      background: var(--sidebar-bg);
      color: rgba(255, 255, 255, 0.92);
      padding: 16px 24px 32px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: relative;
      box-shadow: 12px 0 32px rgba(18, 38, 63, 0.25);
      z-index: 2;
    }

    .logo {
      display: block;
    }

    .logo img {
      display: block;
      width: 160px;
      max-width: 100%;
      height: auto;
    }

    .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .menu a {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 16px;
      border-radius: 14px;
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      font-weight: 500;
      transition: background 160ms ease, color 160ms ease;
    }

    .menu a.active,
    .menu a:hover,
    .menu a:focus-visible {
      background: rgba(255, 255, 255, 0.18);
      color: #ffffff;
      outline: none;
    }

    .menu a .icon {
      display: inline-flex;
      width: 32px;
      height: 32px;
      border-radius: 12px;
      align-items: center;
      justify-content: center;
      background: #000;
    }

    .menu a .icon img {
      max-width: 20px;
      max-height: 20px;
      width: 20px;
      height: 20px;
      object-fit: contain;
    }

    main {
      flex: 1;
      padding: 48px clamp(24px, 4vw, 64px);
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    h1 {
      margin: 0;
      font-size: clamp(2rem, 2vw + 1rem, 2.75rem);
    }

    p {
      margin: 0;
      color: var(--text-secondary);
      max-width: 620px;
      line-height: 1.6;
    }

    .page-header {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .goal-detail {
      display: flex;
      flex-direction: column;
      gap: 32px;
    }

    .goal-detail__back {
      align-self: flex-start;
      background: transparent;
      border: none;
      padding: 0;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: color 160ms ease;
    }

    .goal-detail__back:hover,
    .goal-detail__back:focus-visible {
      color: #0f172a;
      outline: none;
    }

    .goal-detail__hero {
      display: grid;
      grid-template-columns: minmax(0, 320px) minmax(0, 1fr);
      gap: 32px;
      align-items: flex-start;
    }

    .goal-detail__image {
      border-radius: 28px;
      overflow: hidden;
      position: relative;
      min-height: 240px;
      max-height: 320px;
      background: rgba(15, 28, 46, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .goal-detail__image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .goal-detail__info {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .goal-detail__info h2 {
      margin: 0;
      font-size: clamp(2rem, 1vw + 1.5rem, 2.5rem);
    }

    .goal-detail__meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
    }

    .goal-detail__meta-item {
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: 18px;
      border: 1px solid rgba(15, 28, 46, 0.08);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .goal-summary.goal-detail__meta-item {
      gap: 14px;
    }

    .goal-detail__meta-item span:first-child {
      font-size: 0.8rem;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      color: rgba(15, 28, 46, 0.58);
    }

    .goal-detail__meta-item span:last-child {
      font-weight: 600;
      color: #0f172a;
    }

    .goal-detail__layout {
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(280px, 360px);
      gap: 32px;
      align-items: flex-start;
    }

    .goal-section {
      background: rgba(255, 255, 255, 0.92);
      border-radius: 28px;
      border: 1px solid rgba(15, 28, 46, 0.08);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .goal-summary__progress {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .goal-summary__progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .goal-summary__progress-label {
      font-weight: 600;
      color: rgba(15, 28, 46, 0.7);
    }

    .goal-summary__progress-value {
      font-size: 1.35rem;
      font-weight: 700;
      color: #0f172a;
    }

    .goal-summary__progress-bar {
      position: relative;
      height: 6px;
      border-radius: 999px;
      background: rgba(15, 28, 46, 0.08);
      overflow: hidden;
    }

    .goal-summary__progress-bar-fill {
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, #6366f1 0%, #22d3ee 100%);
      transform-origin: left center;
      transform: scaleX(0);
      transition: transform 220ms ease;
    }

    .goal-summary__progress-description {
      margin: 0;
      color: rgba(15, 28, 46, 0.6);
      font-weight: 500;
      font-size: 0.85rem;
    }

    .goal-summary__milestones {
      margin: 12px 0 0;
      font-weight: 600;
      color: rgba(15, 28, 46, 0.7);
      font-size: 0.95rem;
    }

    .goal-section__header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .goal-section__title {
      margin: 0;
    }

    .goal-section__title-button {
      border: none;
      background: none;
      padding: 0;
      font: inherit;
      color: inherit;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      position: relative;
    }

    .goal-section__title-button:focus-visible {
      outline: 3px solid rgba(99, 102, 241, 0.4);
      outline-offset: 4px;
      border-radius: 12px;
    }

    .goal-section__title-button[disabled] {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .goal-section__title-text {
      font-size: 1.3rem;
      font-weight: 600;
    }

    .goal-section__title-icon {
      display: inline-flex;
      width: 20px;
      height: 20px;
      align-items: center;
      justify-content: center;
      color: rgba(15, 28, 46, 0.65);
      transition: transform 160ms ease;
    }

    .goal-section__title-button[data-state="open"] .goal-section__title-icon {
      transform: rotate(180deg);
    }

    .goal-section__actions {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .goal-icon-button {
      border: 1px solid #ffffff;
      background: #ffffff;
      color: #0f172a;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      transition: background 160ms ease, border-color 160ms ease, color 160ms ease, transform 160ms ease;
      position: relative;
    }

    .goal-icon-button svg {
      width: 18px;
      height: 18px;
      pointer-events: none;
    }

    .goal-icon-button:hover,
    .goal-icon-button:focus-visible {
      background: rgba(148, 163, 184, 0.14);
      border-color: rgba(15, 28, 46, 0.18);
      color: #020617;
      transform: translateY(-1px);
      outline: none;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.18);
    }

    .goal-icon-button[data-state="open"],
    .goal-icon-button[aria-pressed="true"] {
      background: rgba(148, 163, 184, 0.18);
      border-color: rgba(15, 28, 46, 0.22);
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.18);
    }

    .goal-icon-button[disabled] {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .goal-section__action-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      background: var(--chip-bg);
      color: rgba(255, 255, 255, 0.9);
    }

    .chip--light {
      background: rgba(15, 28, 46, 0.08);
      color: rgba(15, 28, 46, 0.85);
    }

    .goal-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin: 0;
      padding: 0;
      list-style: none;
    }

    .goal-list__item {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 20px;
      padding: 18px 20px;
      border: 1px solid rgba(15, 28, 46, 0.08);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
    }

    .goal-milestone[data-completed="true"] {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(22, 163, 74, 0.35);
    }

    .goal-list__item::after {
      content: '';
      position: absolute;
      left: 24px;
      right: 24px;
      bottom: -9px;
      height: 2px;
      background: rgba(15, 28, 46, 0.08);
      border-radius: 999px;
      opacity: 0;
      transition: opacity 160ms ease;
    }

    .goal-list__item.is-drag-over::after {
      opacity: 1;
    }

    .goal-list__label {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .goal-list__label span:first-child {
      font-weight: 600;
    }

    .goal-list__label span:not(:first-child) {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .goal-milestone__deadline {
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .goal-milestone__deadline::before {
      content: '⏰';
      font-size: 0.9rem;
    }

    .goal-milestone__header {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .goal-milestone__info {
      display: flex;
      align-items: flex-start;
      gap: 18px;
      flex: 1;
      min-width: 0;
    }

    .goal-milestone__status {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      min-width: 56px;
    }

    .goal-milestone__status-ring {
      --goal-status-color: #6366f1;
      --goal-status-background: rgba(148, 163, 184, 0.25);
      --goal-status-degree: 0deg;
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: conic-gradient(var(--goal-status-color) var(--goal-status-degree), var(--goal-status-background) 0deg);
      display: grid;
      place-items: center;
      position: relative;
      color: #1f2937;
      font-weight: 600;
      font-size: 0.8rem;
    }

    .goal-milestone__status-ring::after {
      content: '';
      position: absolute;
      inset: 6px;
      background: #ffffff;
      border-radius: 50%;
    }

    .goal-milestone__status-count {
      position: relative;
      z-index: 1;
    }

    .goal-milestone__status-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: rgba(15, 28, 46, 0.6);
      font-weight: 600;
    }

    .goal-milestone__actions {
      display: inline-flex;
      align-items: flex-start;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
      margin-left: auto;
    }

    .goal-milestone__edit,
    .goal-milestone__toggle,
    .goal-milestone__todo-add {
      font: inherit;
    }

    .goal-milestone__todos {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .goal-milestone__todo-content {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .goal-milestone__todo-content .empty-state {
      margin: 0;
    }

    .goal-milestone__todo-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .goal-milestone__todo-item {
      background: rgba(248, 250, 252, 0.9);
      border-radius: 12px;
      padding: 6px 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
    }

    .goal-milestone__todo-item[data-completed="true"] {
      background: rgba(226, 232, 240, 0.7);
      border-color: rgba(148, 163, 184, 0.45);
    }

    .goal-list__todo {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      width: 100%;
      justify-content: space-between;
    }

    .goal-list__todo-main {
      display: inline-flex;
      align-items: flex-start;
      gap: 10px;
      flex: 1;
      min-width: 0;
    }

    .goal-list__todo-actions {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .goal-list__todo label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
      font-weight: 400;
      color: #0f172a;
    }

    .goal-list__todo-title {
      font-weight: 400;
    }

    .goal-milestone__todo-item[data-completed="true"] .goal-list__todo-title {
      text-decoration: line-through;
      color: rgba(15, 28, 46, 0.6);
    }

    .goal-list__todo input[type="checkbox"] {
      width: 20px;
      height: 20px;
      accent-color: #2563eb;
      flex-shrink: 0;
    }

    .goal-milestone__todo-delete {
      border: none;
      background: transparent;
      color: #b91c1c;
      padding: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: color 160ms ease;
    }

    .goal-milestone__todo-delete svg {
      width: 18px;
      height: 18px;
    }

    .goal-milestone__todo-delete:hover,
    .goal-milestone__todo-delete:focus-visible {
      color: #7f1d1d;
    }

    .goal-milestone__todo-delete:focus-visible {
      outline: 2px solid rgba(185, 28, 28, 0.4);
      border-radius: 6px;
    }

    .goal-milestone__todo-form {
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto;
      gap: 12px;
      align-items: center;
      padding: 16px;
      border-radius: 16px;
      border: 1px dashed rgba(37, 99, 235, 0.35);
      background: rgba(248, 250, 252, 0.9);
    }

    .goal-milestone__todo-form[hidden] {
      display: none;
    }

    .goal-milestone__todo-form input[type="text"] {
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      padding: 10px 12px;
      font-size: 0.95rem;
    }

    .goal-milestone__todo-form button[type="submit"] {
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      padding: 10px 14px;
      width: 48px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 1.35rem;
      font-weight: 600;
      cursor: pointer;
    }

    .goal-milestone__todo-form button[type="submit"]:hover,
    .goal-milestone__todo-form button[type="submit"]:focus-visible {
      background: #1d4ed8;
      outline: none;
    }

    .goal-section__form {
      padding: 18px;
      border-radius: 20px;
      border: 1px dashed rgba(37, 99, 235, 0.35);
      background: rgba(248, 250, 252, 0.9);
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .goal-section__form[hidden] {
      display: none;
    }

    .goal-section__form input[type="text"] {
      flex: 1;
      min-width: 160px;
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      padding: 10px 12px;
      font-size: 0.95rem;
    }

    .goal-section__form button[type="submit"] {
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
    }

    .goal-section__form button[type="submit"]:hover,
    .goal-section__form button[type="submit"]:focus-visible {
      background: #1d4ed8;
      outline: none;
    }

    .goal-sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }


    .goal-detail__notes {
      position: sticky;
      top: 48px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .goal-notes {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .goal-notes__actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      width: 100%;
    }

    .goal-notes__search {
      flex: 1;
      min-width: 160px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      font-size: 0.95rem;
    }

    .goal-notes__add {
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      transition: background 160ms ease;
    }

    .goal-notes__add:hover,
    .goal-notes__add:focus-visible {
      background: #1d4ed8;
      outline: none;
    }

    .goal-note {
      border-radius: 18px;
      border: 1px solid rgba(15, 28, 46, 0.08);
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.92);
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 160ms ease, box-shadow 160ms ease;
    }

    .goal-note:hover,
    .goal-note:focus-within {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(15, 28, 46, 0.16);
      outline: none;
    }

    .goal-note__open {
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      text-align: left;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      color: inherit;
      width: 100%;
    }

    .goal-note__open:focus-visible {
      outline: none;
    }

    .goal-note__title {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
    }

    .goal-note__preview {
      margin: 0;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .empty-state {
      border-radius: 20px;
      border: 1px dashed rgba(15, 28, 46, 0.12);
      padding: 24px;
      text-align: center;
      color: var(--text-secondary);
      font-weight: 500;
      background: rgba(255, 255, 255, 0.75);
    }

    .note-modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 28, 46, 0.45);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 10;
    }

    .note-modal[hidden] {
      display: none;
    }

    .note-modal__dialog {
      background: #ffffff;
      border-radius: 24px;
      max-width: 480px;
      width: min(100%, 480px);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      position: relative;
    }

    .note-modal__dialog--form {
      max-width: 520px;
    }

    .note-modal__dialog button[type="button"]:not(.goal-icon-button) {
      align-self: flex-end;
      border: none;
      background: transparent;
      font-weight: 600;
      cursor: pointer;
    }

    .note-modal__dialog h3 {
      margin: 0;
      font-size: 1.4rem;
    }

    .note-modal__header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .note-modal__actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-left: auto;
    }

    .note-modal__actions .goal-icon-button {
      width: 36px;
      height: 36px;
      border-radius: 14px;
    }

    .note-modal__content {
      margin: 0;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      gap: 12px;
      line-height: 1.7;
      word-break: break-word;
    }

    .note-modal__content p {
      margin: 0;
    }

    .note-modal__content p + p,
    .note-modal__content ul + p,
    .note-modal__content ol + p,
    .note-modal__content p + ul,
    .note-modal__content p + ol,
    .note-modal__content h2 + p,
    .note-modal__content h3 + p,
    .note-modal__content h4 + p {
      margin-top: 8px;
    }

    .note-modal__content ul,
    .note-modal__content ol {
      margin: 0;
      padding-left: 20px;
      color: inherit;
    }

    .note-modal__content li + li {
      margin-top: 4px;
    }

    .note-modal__content h2,
    .note-modal__content h3,
    .note-modal__content h4 {
      margin: 0;
      color: var(--text-primary);
      font-weight: 600;
    }

    .note-modal__content h2 {
      font-size: 1.35rem;
    }

    .note-modal__content h3 {
      font-size: 1.15rem;
    }

    .note-modal__content h4 {
      font-size: 1.05rem;
    }

    .note-modal__content h2 + *,
    .note-modal__content h3 + *,
    .note-modal__content h4 + * {
      margin-top: 8px;
    }

    .note-modal__content a {
      color: #2563eb;
      text-decoration: underline;
    }

    .note-modal__content a:focus-visible {
      outline: 2px solid rgba(37, 99, 235, 0.6);
      outline-offset: 2px;
    }

    .stacked-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .stacked-form input,
    .stacked-form textarea {
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      padding: 10px 12px;
      font-size: 0.95rem;
    }

    .stacked-form button[type="submit"] {
      border-radius: 12px;
      border: none;
      background: #2563eb;
      color: #ffffff;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
    }

    .note-editor {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .note-editor__toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .note-editor__toolbar button {
      border-radius: 10px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      background: rgba(15, 28, 46, 0.04);
      padding: 6px 10px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      color: var(--text-primary);
      transition: background 160ms ease, border-color 160ms ease, color 160ms ease;
    }

    .note-editor__toolbar button:hover,
    .note-editor__toolbar button:focus-visible {
      outline: none;
      background: rgba(37, 99, 235, 0.12);
      border-color: rgba(37, 99, 235, 0.32);
      color: #1d4ed8;
    }

    .note-editor__toolbar button[aria-pressed="true"] {
      background: rgba(37, 99, 235, 0.18);
      border-color: rgba(37, 99, 235, 0.4);
      color: #1d4ed8;
    }

    .note-editor__content {
      min-height: 160px;
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.12);
      padding: 12px;
      font-size: 0.95rem;
      line-height: 1.6;
      background: rgba(248, 250, 252, 0.85);
      overflow: auto;
      resize: vertical;
      transition: border-color 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }

    .note-editor__content:focus-visible {
      outline: none;
      border-color: rgba(37, 99, 235, 0.45);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.18);
      background: #ffffff;
    }

    .note-editor__content:empty:before {
      content: attr(data-placeholder);
      color: rgba(15, 28, 46, 0.38);
      pointer-events: none;
    }

    .note-editor__content h2,
    .note-editor__content h3,
    .note-editor__content h4 {
      margin: 0;
      font-weight: 600;
    }

    .note-editor__content ul,
    .note-editor__content ol {
      margin: 0;
      padding-left: 20px;
    }

    .note-editor__content li + li {
      margin-top: 4px;
    }

    .goal-milestone__complete-button {
      border-radius: 12px;
      border: 1px solid rgba(15, 28, 46, 0.2);
      background: rgba(15, 28, 46, 0.05);
      color: var(--text-primary);
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      align-self: flex-start;
      transition: background 160ms ease, border-color 160ms ease, color 160ms ease;
    }

    .goal-milestone__complete-button[aria-pressed="true"] {
      background: rgba(34, 197, 94, 0.16);
      border-color: rgba(22, 163, 74, 0.35);
      color: #166534;
    }

    @media (max-width: 1080px) {
      body {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        padding: 24px;
        gap: 20px;
      }

      .menu {
        flex-direction: row;
        flex-wrap: wrap;
      }

      .goal-detail__hero {
        grid-template-columns: 1fr;
      }

      .goal-detail__layout {
        grid-template-columns: 1fr;
      }

      .goal-detail__notes {
        position: static;
      }

      .goal-section {
        padding: 18px;
      }

      .goal-section__form {
        flex-direction: column;
        align-items: stretch;
      }

      .goal-section__form button[type="submit"] {
        width: 100%;
      }

      .goal-milestone__todo-form {
        grid-template-columns: 1fr;
      }

      .goal-milestone__todo-form button[type="submit"] {
        width: 100%;
      }

      .goal-milestone__actions {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="logo">
      <img src="images/logo%20white.png" alt="Easylife logo" />
    </div>
    <nav class="menu" aria-label="Hovedmeny">
      <a href="index.html"><span class="icon"><img src="images/Icon_home2.png" alt="Hjem" /></span>Dashboard</a>
      <a class="active" href="mal.html"><span class="icon"><img src="images/Icon_goal2.png" alt="Mål" /></span>Mål</a>
      <a href="todo.html"><span class="icon"><img src="images/Icon_todo2.png" alt="Todo" /></span>Todo</a>
      <a href="rutiner.html"><span class="icon"><img src="images/Icon_routine2.png" alt="Rutiner" /></span>Rutiner</a>
      <a href="training.html"><span class="icon"><img src="images/Icon_train2.png" alt="Trening" /></span>Training og kostholdsplan</a>
    </nav>
  </aside>
  <main>
    <section class="goal-detail" id="goal-detail" aria-live="polite" hidden>
      <button class="goal-detail__back" type="button" id="goal-detail-back">← Tilbake til oversikten</button>
      <div class="goal-detail__hero">
        <div class="goal-detail__image">
          <img id="goal-detail-image" src="" alt="" loading="lazy" />
        </div>
        <div class="goal-detail__info">
          <h2 id="goal-detail-title"></h2>
          <p id="goal-detail-why"></p>
          <div class="goal-detail__meta">
            <div class="goal-detail__meta-item">
              <span>Deadline</span>
              <span id="goal-detail-deadline"></span>
            </div>
            <div class="goal-detail__meta-item">
              <span>Kategori</span>
              <span id="goal-detail-category"></span>
            </div>
            <div class="goal-detail__meta-item">
              <span>Hvorfor det er viktig</span>
              <span id="goal-detail-important"></span>
            </div>
            <section class="goal-detail__meta-item goal-summary" id="goal-summary" aria-live="polite">
              <div class="goal-summary__progress">
                <div class="goal-summary__progress-header">
                  <span class="goal-summary__progress-label" id="goal-summary-progress-label">Total fremdrift</span>
                  <span class="goal-summary__progress-value" id="goal-summary-progress">0%</span>
                </div>
                <div
                  class="goal-summary__progress-bar"
                  id="goal-summary-progress-track"
                  role="progressbar"
                  aria-labelledby="goal-summary-progress-label"
                  aria-valuemin="0"
                  aria-valuemax="100"
                  aria-valuenow="0"
                >
                  <div class="goal-summary__progress-bar-fill" id="goal-summary-progress-bar"></div>
                </div>
                <p class="goal-summary__progress-description" id="goal-summary-progress-description">Ingen to-dos registrert</p>
              </div>
              <p class="goal-summary__milestones" id="goal-summary-milestone-status">Milepæler 0/0 fullført</p>
            </section>
          </div>
        </div>
      </div>
      <div class="goal-detail__layout">
        <div class="goal-detail__main">
          <section class="goal-section" aria-labelledby="goal-milestones-title">
            <div class="goal-section__header">
              <h3 class="goal-section__title">
                <button type="button" class="goal-section__title-button" id="goal-milestones-title" data-state="closed" aria-expanded="false">
                  <span class="goal-section__title-text">Milepæler</span>
                  <span class="goal-section__title-icon" aria-hidden="true"></span>
                  <span class="goal-sr-only">Vis alle milepæler</span>
                </button>
              </h3>
              <div class="goal-section__actions">
                <button type="button" class="goal-section__action-button goal-icon-button" id="goal-milestone-add-button" aria-expanded="false">
                  <span class="goal-sr-only">Legg til milepæl</span>
                </button>
              </div>
            </div>
            <ul class="goal-list goal-milestone-list" id="goal-milestone-list"></ul>
            <form class="goal-section__form" id="goal-milestone-form" hidden>
              <input type="text" name="milestone-title" placeholder="Legg til milepæl" required />
              <input type="text" name="milestone-detail" placeholder="Detaljer (valgfritt)" />
              <button type="submit">Legg til</button>
            </form>
          </section>
        </div>
        <aside class="goal-detail__notes">
          <section class="goal-section" aria-labelledby="goal-notes-title">
            <div class="goal-section__header">
              <h3 id="goal-notes-title">Notater</h3>
              <div class="goal-notes__actions">
                <input type="search" id="goal-notes-search" class="goal-notes__search" placeholder="Søk i notater" aria-label="Søk i notater" />
                <button type="button" class="goal-notes__add" id="goal-add-note">Nytt notat</button>
              </div>
            </div>
            <div class="goal-notes" id="goal-notes-list"></div>
          </section>
        </aside>
      </div>
    </section>
    <section class="empty-state" id="goal-detail-empty" hidden>
      Kunne ikke finne dette målet. <a href="mal.html">Gå tilbake til oversikten.</a>
    </section>
  </main>
  <div class="note-modal" id="goal-note-modal" role="dialog" aria-modal="true" aria-hidden="true" hidden>
    <div class="note-modal__dialog">
      <button type="button" id="goal-note-close">Lukk</button>
      <div class="note-modal__header">
        <h3 id="goal-note-modal-title"></h3>
        <div class="note-modal__actions">
          <button type="button" class="goal-icon-button" id="goal-note-edit"></button>
          <button type="button" class="goal-icon-button" id="goal-note-delete"></button>
        </div>
      </div>
      <div class="note-modal__content" id="goal-note-modal-content"></div>
    </div>
  </div>
  <div class="note-modal" id="goal-note-create-modal" role="dialog" aria-modal="true" aria-hidden="true" hidden>
    <div class="note-modal__dialog note-modal__dialog--form">
      <button type="button" id="goal-note-create-close">Lukk</button>
      <h3 id="goal-note-create-title">Nytt notat</h3>
      <form class="stacked-form" id="goal-note-create-form">
        <input type="text" name="note-title" placeholder="Tittel" required />
        <div class="note-editor">
          <div
            class="note-editor__toolbar"
            id="goal-note-toolbar"
            role="toolbar"
            aria-label="Tekstformatering"
          >
            <button type="button" data-command="bold" aria-pressed="false" aria-label="Fet tekst" title="Fet tekst">
              <strong>F</strong>
            </button>
            <button type="button" data-command="italic" aria-pressed="false" aria-label="Kursiv tekst" title="Kursiv tekst">
              <em>K</em>
            </button>
            <button
              type="button"
              data-command="insertUnorderedList"
              aria-pressed="false"
              aria-label="Punktliste"
              title="Punktliste"
            >
              •••
            </button>
            <button
              type="button"
              data-command="insertOrderedList"
              aria-pressed="false"
              aria-label="Nummerert liste"
              title="Nummerert liste"
            >
              123
            </button>
          </div>
          <div
            class="note-editor__content"
            id="goal-note-editor"
            contenteditable="true"
            role="textbox"
            aria-multiline="true"
            data-placeholder="Skriv notatet ditt her"
          ></div>
        </div>
        <input type="hidden" name="note-content" />
        <button type="submit" id="goal-note-submit">Lagre notat</button>
      </form>
    </div>
  </div>
  <div class="note-modal" id="goal-milestone-edit-modal" role="dialog" aria-modal="true" aria-hidden="true" hidden>
    <div class="note-modal__dialog note-modal__dialog--form">
      <button type="button" id="goal-milestone-edit-close">Lukk</button>
      <div class="note-modal__header">
        <h3 id="goal-milestone-edit-title">Rediger milepæl</h3>
        <button type="button" class="goal-icon-button" id="goal-milestone-delete-button">
          <span class="goal-sr-only">Slett milepælen</span>
        </button>
      </div>
      <form class="stacked-form" id="goal-milestone-edit-form">
        <input type="text" name="milestone-title" placeholder="Tittel" aria-label="Tittel" required />
        <textarea name="milestone-detail" rows="3" placeholder="Detaljer" aria-label="Detaljer"></textarea>
        <input type="date" name="milestone-deadline" aria-label="Deadline" />
        <button
          type="button"
          class="goal-milestone__complete-button"
          id="goal-milestone-complete-button"
          aria-pressed="false"
          disabled
        >
          Fullført
        </button>
        <button type="submit">Lagre milepæl</button>
      </form>
    </div>
  </div>
  <script src="goals-data.js"></script>
  <script type="module">
    import supabaseClient from './supabase-client.js';

    (async function () {
      const baseGoalsData = window.EASYLIFE_GOALS_DATA || [];
      const cloneGoal = (goal) => JSON.parse(JSON.stringify(goal || {}));
      const ICON_MARKUP = {
        plus: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="M10 4.167v11.666M4.167 10h11.666" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        close: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="m5.5 5.5 9 9m0-9-9 9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        chevronsDown: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="m5.25 6.75 4.75 4.75 4.75-4.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            <path d="m5.25 11.25 4.75 4.75 4.75-4.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        chevronsUp: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="m5.25 13.25 4.75-4.75 4.75 4.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            <path d="m5.25 8.75 4.75-4.75 4.75 4.75" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        pencil: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="M13.586 3.586a2 2 0 0 1 2.828 2.828l-8.25 8.25-3.664.836.836-3.664 8.25-8.25Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
            <path d="M11.75 5.422 14.58 8.25" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `,
        x: `
          <svg viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">
            <path d="m6 6 8 8m0-8-8 8" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        `
      };

      const getIconMarkup = (name) => (ICON_MARKUP[name] || '').trim();

      const setButtonIconContent = (button, iconName, srText = '') => {
        if (!button) {
          return;
        }

        button.innerHTML = getIconMarkup(iconName);
        if (srText) {
          const srSpan = document.createElement('span');
          srSpan.className = 'goal-sr-only';
          srSpan.textContent = srText;
          button.appendChild(srSpan);
        }
      };
      const NOTE_ALLOWED_TAGS = new Set(['P', 'BR', 'STRONG', 'EM', 'UL', 'OL', 'LI', 'A', 'H2', 'H3', 'H4']);
      const NOTE_URL_PATTERN = /https?:\/\/[^\s<]+/gi;

      const escapeHtml = (value = '') =>
        String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const linkifyElement = (root) => {
        if (!root) {
          return;
        }

        const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
        const textNodes = [];
        while (walker.nextNode()) {
          const current = walker.currentNode;
          if (!current || !current.textContent) {
            continue;
          }

          const parentAnchor = current.parentElement?.closest('a');
          if (parentAnchor) {
            continue;
          }

          textNodes.push(current);
        }

        textNodes.forEach((textNode) => {
          const text = textNode.textContent;
          if (!text) {
            return;
          }

          const matches = text.match(NOTE_URL_PATTERN);
          if (!matches) {
            return;
          }

          const fragment = document.createDocumentFragment();
          let lastIndex = 0;

          text.replace(NOTE_URL_PATTERN, (match, offset) => {
            const prefix = text.slice(lastIndex, offset);
            if (prefix) {
              fragment.appendChild(document.createTextNode(prefix));
            }

            const anchor = document.createElement('a');
            anchor.textContent = match;
            anchor.href = match;
            anchor.target = '_blank';
            anchor.rel = 'noopener noreferrer';
            fragment.appendChild(anchor);

            lastIndex = offset + match.length;
            return match;
          });

          const suffix = text.slice(lastIndex);
          if (suffix) {
            fragment.appendChild(document.createTextNode(suffix));
          }

          textNode.replaceWith(fragment);
        });
      };

      const sanitizeNoteHtml = (inputHtml) => {
        if (!inputHtml) {
          return '';
        }

        const container = document.createElement('div');
        container.innerHTML = inputHtml;

        const convertElement = (element, newTag) => {
          const replacement = document.createElement(newTag);
          while (element.firstChild) {
            replacement.appendChild(element.firstChild);
          }
          element.replaceWith(replacement);
          return replacement;
        };

        const sanitizeNode = (node) => {
          if (!node) {
            return;
          }

          if (node.nodeType === Node.TEXT_NODE) {
            return;
          }

          if (node.nodeType === Node.COMMENT_NODE) {
            node.remove();
            return;
          }

          if (node.nodeType !== Node.ELEMENT_NODE) {
            node.remove();
            return;
          }

          let currentNode = node;
          let tagName = currentNode.tagName;

          if (tagName === 'B') {
            currentNode = convertElement(currentNode, 'strong');
            tagName = 'STRONG';
          } else if (tagName === 'I') {
            currentNode = convertElement(currentNode, 'em');
            tagName = 'EM';
          } else if (tagName === 'H1') {
            currentNode = convertElement(currentNode, 'h2');
            tagName = 'H2';
          } else if (tagName === 'DIV') {
            currentNode = convertElement(currentNode, 'p');
            tagName = 'P';
          }

          if (!NOTE_ALLOWED_TAGS.has(tagName)) {
            if (tagName === 'SPAN') {
              while (currentNode.firstChild) {
                currentNode.parentNode?.insertBefore(currentNode.firstChild, currentNode);
              }
              currentNode.remove();
              return;
            }

            while (currentNode.firstChild) {
              currentNode.parentNode?.insertBefore(currentNode.firstChild, currentNode);
            }
            currentNode.remove();
            return;
          }

          if (tagName === 'A') {
            const href = currentNode.getAttribute('href') || '';
            if (!/^https?:\/\//i.test(href.trim())) {
              const fallbackText = currentNode.textContent || '';
              currentNode.replaceWith(document.createTextNode(fallbackText));
              return;
            }

            currentNode.setAttribute('href', href.trim());
            currentNode.setAttribute('target', '_blank');
            currentNode.setAttribute('rel', 'noopener noreferrer');
            Array.from(currentNode.attributes).forEach((attr) => {
              if (!['href', 'target', 'rel'].includes(attr.name)) {
                currentNode.removeAttribute(attr.name);
              }
            });
          } else {
            Array.from(currentNode.attributes).forEach((attr) => {
              currentNode.removeAttribute(attr.name);
            });
          }

          Array.from(currentNode.childNodes).forEach((child) => sanitizeNode(child));

          if (['P', 'H2', 'H3', 'H4', 'LI'].includes(currentNode.tagName)) {
            const textValue = (currentNode.textContent || '').trim();
            const hasContent = textValue || currentNode.querySelector('a, strong, em, ul, ol');
            if (!hasContent) {
              currentNode.remove();
            }
          }

          if ((currentNode.tagName === 'UL' || currentNode.tagName === 'OL') && !currentNode.childElementCount) {
            currentNode.remove();
          }
        };

        Array.from(container.childNodes).forEach((child) => {
          if (child.nodeType === Node.TEXT_NODE) {
            const textContent = child.textContent || '';
            if (!textContent.trim()) {
              child.remove();
              return;
            }

            const paragraph = document.createElement('p');
            paragraph.textContent = textContent.trim();
            child.replaceWith(paragraph);
            sanitizeNode(paragraph);
            return;
          }

          sanitizeNode(child);
        });

        linkifyElement(container);

        container.querySelectorAll('a').forEach((anchor) => {
          const href = anchor.getAttribute('href') || '';
          if (!/^https?:\/\//i.test(href.trim())) {
            anchor.replaceWith(document.createTextNode(anchor.textContent || ''));
            return;
          }

          anchor.setAttribute('href', href.trim());
          anchor.setAttribute('target', '_blank');
          anchor.setAttribute('rel', 'noopener noreferrer');
        });

        container.normalize();

        return container.innerHTML.trim();
      };

      const extractPlainTextFromHtml = (html) => {
        if (!html) {
          return '';
        }

        const temp = document.createElement('div');
        temp.innerHTML = html;
        return (temp.textContent || '').replace(/\s+/g, ' ').trim();
      };

      const normalizeGoalNote = (note) => {
        const initial = note && typeof note === 'object' ? { ...note } : {};
        const titleValue = typeof initial.title === 'string' ? initial.title.trim() : '';
        const rawContent = typeof initial.content === 'string' ? initial.content : '';
        const baseHtml = rawContent && /</.test(rawContent) ? rawContent : rawContent ? `<p>${escapeHtml(rawContent)}</p>` : '';
        const sanitizedHtml = sanitizeNoteHtml(baseHtml);

        initial.title = titleValue || 'Notat';
        const plainCandidate = typeof initial.plainText === 'string' ? initial.plainText.trim() : '';
        initial.content = sanitizedHtml;
        initial.plainText = plainCandidate || extractPlainTextFromHtml(sanitizedHtml || rawContent);
        initial.__isSanitized = true;
        return initial;
      };

      const getNotePlainText = (note) => {
        if (!note) {
          return '';
        }

        if (typeof note.plainText === 'string' && note.plainText.trim()) {
          return note.plainText.trim();
        }

        return extractPlainTextFromHtml(note.content || '');
      };

      const setNoteEditorContent = (html) => {
        if (!noteEditor) {
          return;
        }

        noteEditor.innerHTML = html || '';
      };

      const getNoteEditorHtml = () => {
        if (!noteEditor) {
          return '';
        }

        return sanitizeNoteHtml(noteEditor.innerHTML);
      };

      const updateToolbarState = () => {
        if (!noteToolbar || !noteEditor) {
          return;
        }

        const selection = document.getSelection();
        const activeElement = document.activeElement;
        const anchorNode = selection?.anchorNode || null;
        const isInsideEditor =
          noteEditor === activeElement ||
          noteEditor.contains(activeElement) ||
          (anchorNode instanceof Node && noteEditor.contains(anchorNode));

        const commandButtons = noteToolbar.querySelectorAll('button[data-command]');
        commandButtons.forEach((button) => {
          const { command } = button.dataset;
          let isActive = false;

          if (isInsideEditor && command) {
            try {
              isActive = document.queryCommandState(command);
            } catch (error) {
              isActive = false;
            }
          }

          button.setAttribute('aria-pressed', isActive ? 'true' : 'false');
        });
      };
      const parseIndexParam = (value) => {
        if (typeof value !== 'string') {
          return Number.NaN;
        }

        const trimmed = value.trim();
        if (!/^\d+$/.test(trimmed)) {
          return Number.NaN;
        }

        return Number.parseInt(trimmed, 10);
      };

      const goalDetailSection = document.getElementById('goal-detail');
      const emptyStateSection = document.getElementById('goal-detail-empty');
      const goalDetailBackButton = document.getElementById('goal-detail-back');
      const goalDetailImage = document.getElementById('goal-detail-image');
      const goalDetailTitle = document.getElementById('goal-detail-title');
      const goalDetailWhy = document.getElementById('goal-detail-why');
      const goalDetailDeadline = document.getElementById('goal-detail-deadline');
      const goalDetailCategory = document.getElementById('goal-detail-category');
      const goalDetailImportant = document.getElementById('goal-detail-important');
      const milestoneList = document.getElementById('goal-milestone-list');
      const milestoneHeadingButton = document.getElementById('goal-milestones-title');
      const milestoneFormToggle = document.getElementById('goal-milestone-add-button');
      const milestoneForm = document.getElementById('goal-milestone-form');
      const notesList = document.getElementById('goal-notes-list');
      const notesSearchInput = document.getElementById('goal-notes-search');
      const addNoteButton = document.getElementById('goal-add-note');
      const noteModal = document.getElementById('goal-note-modal');
      const noteModalTitle = document.getElementById('goal-note-modal-title');
      const noteModalContent = document.getElementById('goal-note-modal-content');
      const noteModalClose = document.getElementById('goal-note-close');
      const noteModalEditButton = document.getElementById('goal-note-edit');
      const noteModalDeleteButton = document.getElementById('goal-note-delete');
      const noteCreateModal = document.getElementById('goal-note-create-modal');
      const noteCreateClose = document.getElementById('goal-note-create-close');
      const noteCreateForm = document.getElementById('goal-note-create-form');
      const noteCreateTitle = document.getElementById('goal-note-create-title');
      const noteCreateSubmitButton = document.getElementById('goal-note-submit');
      const noteToolbar = document.getElementById('goal-note-toolbar');
      const noteEditor = document.getElementById('goal-note-editor');
      const milestoneEditModal = document.getElementById('goal-milestone-edit-modal');
      const milestoneEditClose = document.getElementById('goal-milestone-edit-close');
      const milestoneEditForm = document.getElementById('goal-milestone-edit-form');
      const milestoneDeleteButton = document.getElementById('goal-milestone-delete-button');
      const milestoneCompleteButton = document.getElementById('goal-milestone-complete-button');
      const goalSummarySection = document.getElementById('goal-summary');
      const goalSummaryProgressValue = document.getElementById('goal-summary-progress');
      const goalSummaryProgressTrack = document.getElementById('goal-summary-progress-track');
      const goalSummaryProgressBar = document.getElementById('goal-summary-progress-bar');
      const goalSummaryProgressDescription = document.getElementById('goal-summary-progress-description');
      const goalSummaryMilestoneStatus = document.getElementById('goal-summary-milestone-status');

      if (noteModalEditButton) {
        setButtonIconContent(noteModalEditButton, 'pencil', 'Rediger notatet');
        noteModalEditButton.disabled = true;
      }

      if (noteModalDeleteButton) {
        setButtonIconContent(noteModalDeleteButton, 'x', 'Slett notatet');
        noteModalDeleteButton.disabled = true;
      }

      if (milestoneDeleteButton) {
        setButtonIconContent(milestoneDeleteButton, 'x', 'Slett milepælen');
        milestoneDeleteButton.disabled = true;
      }

      const currentUrl = new URL(window.location.href);
      const goalParam = currentUrl.searchParams.get('goal');
      const fallbackGoalParam = currentUrl.searchParams.get('goalIndex');

      const parsedGoalIndex = parseIndexParam(goalParam);
      const parsedFallbackIndex = parseIndexParam(fallbackGoalParam);

      const hasLegacyGoalIndex =
        Number.isInteger(parsedGoalIndex) && parsedGoalIndex >= 0 && parsedGoalIndex < baseGoalsData.length;
      const hasFallbackGoalIndex =
        Number.isInteger(parsedFallbackIndex) && parsedFallbackIndex >= 0 && parsedFallbackIndex < baseGoalsData.length;

      let fallbackGoalIndex = hasFallbackGoalIndex ? parsedFallbackIndex : hasLegacyGoalIndex ? parsedGoalIndex : null;
      const goalIdentifier =
        typeof goalParam === 'string' && goalParam.trim() && !/^\d+$/.test(goalParam.trim())
          ? goalParam.trim()
          : null;

      let currentGoal = null;
      let currentUserId = null;
      let noteSearchQuery = '';
      let noteEditIndex = null;
      let noteModalIndex = null;
      let activeModalCount = 0;
      let milestoneFormIsOpen = false;
      let milestoneEditIndex = null;

      const mapDatabaseTodo = (todo, index = 0, { fallbackMilestoneId } = {}) => ({
        id: todo?.id ?? null,
        milestoneId: todo?.milestone_id ?? todo?.milestoneId ?? fallbackMilestoneId ?? null,
        title: todo?.title ?? '',
        detail: todo?.detail ?? '',
        completed: Boolean(todo?.completed),
        position: typeof todo?.position === 'number' ? todo.position : index
      });

      const mapDatabaseMilestone = (milestone, index = 0, { fallbackGoalId } = {}) => {
        const mapped = {
          id: milestone?.id ?? null,
          goalId: milestone?.goal_id ?? milestone?.goalId ?? fallbackGoalId ?? null,
          title: milestone?.title ?? '',
          detail: milestone?.detail ?? '',
          completed: Boolean(milestone?.completed),
          progress: milestone?.progress ?? null,
          deadline: milestone?.deadline ?? '',
          position: typeof milestone?.position === 'number' ? milestone.position : index,
          isExpanded: typeof milestone?.isExpanded === 'boolean' ? milestone.isExpanded : false,
          isTodoFormOpen: Boolean(milestone?.isTodoFormOpen),
          shouldFocusTodoTitle: Boolean(milestone?.shouldFocusTodoTitle),
          todos: []
        };

        const todosSource = Array.isArray(milestone?.goal_milestone_todos)
          ? milestone.goal_milestone_todos
          : Array.isArray(milestone?.todos)
            ? milestone.todos
            : [];

        mapped.todos = todosSource.map((todo, todoIndex) => {
          const mappedTodo = mapDatabaseTodo(todo, todoIndex, { fallbackMilestoneId: mapped.id });
          if (!mappedTodo.milestoneId && mapped.id) {
            mappedTodo.milestoneId = mapped.id;
          }
          return mappedTodo;
        });

        return mapped;
      };

      const mapDatabaseNote = (note, { fallbackGoalId } = {}) =>
        normalizeGoalNote({
          id: note?.id ?? null,
          goalId: note?.goal_id ?? note?.goalId ?? fallbackGoalId ?? null,
          title: note?.title ?? '',
          content: note?.content_html ?? note?.content ?? '',
          plainText: note?.content_plain ?? note?.plainText ?? '',
          createdAt: note?.created_at ?? note?.createdAt ?? null,
          updatedAt: note?.updated_at ?? note?.updatedAt ?? null
        });

      const mapDatabaseGoal = (goal) => {
        const milestoneSource = Array.isArray(goal?.milestones)
          ? goal.milestones
          : Array.isArray(goal?.goal_milestones)
            ? goal.goal_milestones
            : [];

        const noteSource = Array.isArray(goal?.goal_notes)
          ? goal.goal_notes
          : Array.isArray(goal?.notes)
            ? goal.notes
            : [];

        const mappedNotes = noteSource
          .map((note) => mapDatabaseNote(note, { fallbackGoalId: goal?.id ?? null }))
          .sort((a, b) => {
            const aTime = a?.createdAt ? new Date(a.createdAt).getTime() : 0;
            const bTime = b?.createdAt ? new Date(b.createdAt).getTime() : 0;
            return bTime - aTime;
          });

        return {
          id: goal?.id ?? null,
          title: goal?.title ?? '',
          why: goal?.why ?? '',
          deadline: goal?.deadline ?? '',
          status: goal?.status ?? '0%',
          image: goal?.image ?? '',
          category: goal?.category ?? '',
          important: goal?.important ?? '',
          milestones: milestoneSource.map((milestone, index) =>
            mapDatabaseMilestone(milestone, index, { fallbackGoalId: goal?.id ?? null })
          ),
          notes: mappedNotes,
          todos: Array.isArray(goal?.todos) ? goal.todos : []
        };
      };

      const getGoalDomIdentifier = () => {
        if (currentGoal?.id) {
          return currentGoal.id;
        }

        if (fallbackGoalIndex !== null) {
          return fallbackGoalIndex;
        }

        return 'x';
      };

      const lockBodyScroll = () => {
        activeModalCount += 1;
        if (activeModalCount === 1) {
          document.body.style.overflow = 'hidden';
        }
      };

      const unlockBodyScroll = () => {
        activeModalCount = Math.max(0, activeModalCount - 1);
        if (activeModalCount === 0) {
          document.body.style.overflow = '';
        }
      };

      const setMilestoneFormVisibility = (isVisible, { focusField = false } = {}) => {
        milestoneFormIsOpen = Boolean(isVisible);

        if (milestoneForm) {
          if (milestoneFormIsOpen) {
            milestoneForm.removeAttribute('hidden');
          } else {
            milestoneForm.setAttribute('hidden', '');
            milestoneForm.reset();
          }
        }

        if (milestoneFormToggle) {
          milestoneFormToggle.setAttribute('aria-expanded', milestoneFormIsOpen ? 'true' : 'false');
          milestoneFormToggle.dataset.state = milestoneFormIsOpen ? 'open' : 'closed';
          const srText = milestoneFormIsOpen ? 'Lukk skjema for ny milepæl' : 'Legg til milepæl';
          setButtonIconContent(milestoneFormToggle, milestoneFormIsOpen ? 'close' : 'plus', srText);
        }

        if (milestoneFormIsOpen && focusField && milestoneForm) {
          requestAnimationFrame(() => {
            milestoneForm['milestone-title']?.focus();
          });
        }
      };

      const updateMilestoneCompleteButtonState = ({ completed, disabled } = {}) => {
        if (!milestoneCompleteButton) {
          return;
        }

        if (typeof completed === 'boolean') {
          milestoneCompleteButton.setAttribute('aria-pressed', completed ? 'true' : 'false');
          milestoneCompleteButton.dataset.completed = completed ? 'true' : 'false';
        }

        if (typeof disabled === 'boolean') {
          milestoneCompleteButton.disabled = disabled;
        }
      };

      const formatLongDeadline = (deadline) => {
        if (!deadline) {
          return 'Ingen deadline';
        }

        const date = new Date(deadline);
        if (Number.isNaN(date.getTime())) {
          return deadline;
        }

        return new Intl.DateTimeFormat('nb-NO', {
          day: '2-digit',
          month: 'long',
          year: 'numeric'
        }).format(date);
      };

      const formatShortDeadline = (deadline) => {
        if (!deadline) {
          return '';
        }

        const date = new Date(deadline);
        if (Number.isNaN(date.getTime())) {
          return String(deadline);
        }

        return new Intl.DateTimeFormat('nb-NO', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        }).format(date);
      };

      const formatDateForInput = (value) => {
        if (!value) {
          return '';
        }

        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
          return '';
        }

        return date.toISOString().slice(0, 10);
      };

      function ensureGoalCollections(goal) {
        if (!goal) {
          return;
        }

        if (!Array.isArray(goal.milestones)) {
          goal.milestones = [];
        }

        if (Array.isArray(goal.todos) && goal.todos.length) {
          const [firstMilestone] = goal.milestones;
          if (firstMilestone && Array.isArray(firstMilestone.todos)) {
            firstMilestone.todos.push(...goal.todos);
          } else if (firstMilestone) {
            firstMilestone.todos = [...goal.todos];
          } else {
            goal.milestones.push({
              title: 'Oppgaver',
              detail: '',
              completed: false,
              todos: [...goal.todos]
            });
          }
          goal.todos = [];
        }

        goal.milestones.forEach((milestone, index) => {
          if (!milestone || typeof milestone !== 'object') {
            goal.milestones[index] = {
              title: '',
              detail: '',
              completed: false,
              todos: [],
              isExpanded: false,
              isTodoFormOpen: false,
              shouldFocusTodoTitle: false
            };
            return;
          }

          if (!Array.isArray(milestone.todos)) {
            milestone.todos = [];
          }

          milestone.todos = milestone.todos.map((todo, todoIndex) => {
            const mappedTodo = mapDatabaseTodo(todo, todoIndex, { fallbackMilestoneId: milestone.id ?? null });
            if (typeof mappedTodo.position !== 'number') {
              mappedTodo.position = todoIndex;
            }
            return mappedTodo;
          });

          if (typeof milestone.position !== 'number') {
            milestone.position = index;
          }

          if (typeof milestone.deadline !== 'string') {
            milestone.deadline = milestone.deadline ? String(milestone.deadline) : '';
          }

          if (typeof milestone.deadline === 'string') {
            milestone.deadline = milestone.deadline.trim();
          }

          if (typeof milestone.isExpanded !== 'boolean') {
            milestone.isExpanded = false;
          }

          if (typeof milestone.isTodoFormOpen !== 'boolean') {
            milestone.isTodoFormOpen = false;
          }

          if (typeof milestone.shouldFocusTodoTitle !== 'boolean') {
            milestone.shouldFocusTodoTitle = false;
          }
        });

        if (!Array.isArray(goal.notes)) {
          goal.notes = [];
        } else {
          goal.notes = goal.notes.map((note) => normalizeGoalNote(note));
        }
      }

      async function loadGoalFromDatabase(goalId) {
        if (!goalId || !currentUserId) {
          return null;
        }

        try {
          const { data, error } = await supabaseClient
            .from('goals')
            .select(`
              id,
              title,
              why,
              deadline,
              image,
              status,
              category,
              important,
              goal_milestones (
                id,
                goal_id,
                title,
                detail,
                completed,
                progress,
                position,
                deadline,
                goal_milestone_todos (
                  id,
                  milestone_id,
                  title,
                  detail,
                  completed,
                  position
                )
              ),
              goal_notes (
                id,
                goal_id,
                title,
                content_html,
                content_plain,
                created_at,
                updated_at
              )
            `)
            .eq('user_id', currentUserId)
            .eq('id', goalId)
            .order('position', { ascending: true, foreignTable: 'goal_milestones' })
            .order('position', { ascending: true, foreignTable: 'goal_milestones.goal_milestone_todos' })
            .order('created_at', { ascending: false, foreignTable: 'goal_notes' })
            .maybeSingle();

          if (error) {
            throw error;
          }

          if (!data) {
            return null;
          }

          return mapDatabaseGoal(data);
        } catch (loadError) {
          console.error('Feil ved henting av mål fra databasen', loadError);
          return null;
        }
      }

      async function insertMilestoneIntoDatabase(goal, { title, detail, position, deadline }) {
        if (!currentUserId || !goal?.id) {
          return null;
        }

        const payload = {
          goal_id: goal.id,
          title,
          detail: detail ? detail : null,
          completed: false,
          position,
          deadline: deadline ? deadline : null
        };

        const { data, error } = await supabaseClient
          .from('goal_milestones')
          .insert(payload)
          .select('id, goal_id, title, detail, completed, progress, position, deadline')
          .single();

        if (error) {
          throw error;
        }

        return data;
      }

      async function updateMilestoneInDatabase(milestone, updates) {
        if (!currentUserId || !milestone?.id) {
          return null;
        }

        const payload = {
          title: updates.title,
          detail: updates.detail ?? null,
          deadline: updates.deadline ?? null,
          completed: typeof updates.completed === 'boolean' ? updates.completed : undefined
        };

        const filtered = Object.fromEntries(
          Object.entries(payload).filter(([, value]) => value !== undefined)
        );

        if (!Object.keys(filtered).length) {
          return null;
        }

        const { data, error } = await supabaseClient
          .from('goal_milestones')
          .update(filtered)
          .eq('id', milestone.id)
          .select('id, goal_id, title, detail, completed, progress, position, deadline')
          .single();

        if (error) {
          throw error;
        }

        return data;
      }

      async function insertNoteIntoDatabase(goal, { title, contentHtml, contentPlain }) {
        if (!currentUserId || !goal?.id) {
          return null;
        }

        const payload = {
          goal_id: goal.id,
          title,
          content_html: contentHtml,
          content_plain: contentPlain ?? ''
        };

        const { data, error } = await supabaseClient
          .from('goal_notes')
          .insert(payload)
          .select('id, goal_id, title, content_html, content_plain, created_at, updated_at')
          .single();

        if (error) {
          throw error;
        }

        return data;
      }

      async function updateNoteInDatabase(note, updates) {
        if (!currentUserId || !note?.id) {
          return null;
        }

        const payload = {
          title: typeof updates.title === 'string' ? updates.title : undefined,
          content_html: typeof updates.contentHtml === 'string' ? updates.contentHtml : undefined,
          content_plain: typeof updates.contentPlain === 'string' ? updates.contentPlain : undefined
        };

        const filtered = Object.fromEntries(
          Object.entries(payload).filter(([, value]) => value !== undefined)
        );

        if (!Object.keys(filtered).length) {
          return null;
        }

        const goalId = note.goalId ?? note.goal_id ?? null;

        const query = supabaseClient
          .from('goal_notes')
          .update(filtered)
          .eq('id', note.id);

        if (goalId) {
          query.eq('goal_id', goalId);
        }

        const { data, error } = await query
          .select('id, goal_id, title, content_html, content_plain, created_at, updated_at')
          .single();

        if (error) {
          throw error;
        }

        return data;
      }

      async function deleteNoteFromDatabase(note) {
        if (!currentUserId || !note?.id) {
          return;
        }

        const query = supabaseClient
          .from('goal_notes')
          .delete()
          .eq('id', note.id);

        const goalId = note.goalId ?? note.goal_id ?? null;
        if (goalId) {
          query.eq('goal_id', goalId);
        }

        const { error } = await query;

        if (error) {
          throw error;
        }
      }

      async function insertTodoIntoDatabase(goal, milestone, { title, detail, position }) {
        if (!currentUserId || !goal?.id || !milestone?.id) {
          return null;
        }

        const payload = {
          milestone_id: milestone.id,
          title,
          detail: detail ? detail : null,
          completed: false,
          position
        };

        const { data, error } = await supabaseClient
          .from('goal_milestone_todos')
          .insert(payload)
          .select('id, milestone_id, title, detail, completed, position')
          .single();

        if (error) {
          throw error;
        }

        return data;
      }

      async function updateTodoCompletionInDatabase(todo, completed) {
        if (!currentUserId || !todo?.id) {
          return;
        }

        const query = supabaseClient
          .from('goal_milestone_todos')
          .update({ completed })
          .eq('id', todo.id);

        if (todo.milestoneId) {
          query.eq('milestone_id', todo.milestoneId);
        }

        const { error } = await query;

        if (error) {
          throw error;
        }
      }

      async function deleteTodoFromDatabase(todo) {
        if (!currentUserId || !todo?.id) {
          return;
        }

        const query = supabaseClient.from('goal_milestone_todos').delete().eq('id', todo.id);

        if (todo.milestoneId) {
          query.eq('milestone_id', todo.milestoneId);
        }

        const { error } = await query;

        if (error) {
          throw error;
        }
      }

      async function deleteMilestoneFromDatabase(milestone) {
        if (!currentUserId || !milestone?.id) {
          return;
        }

        await supabaseClient.from('goal_milestone_todos').delete().eq('milestone_id', milestone.id);

        const { error } = await supabaseClient.from('goal_milestones').delete().eq('id', milestone.id);

        if (error) {
          throw error;
        }
      }

      async function persistMilestoneOrder(goal) {
        if (!currentUserId || !goal?.id) {
          return;
        }

        const updates = goal.milestones
          .filter((milestone) => milestone?.id)
          .map((milestone, index) =>
            supabaseClient
              .from('goal_milestones')
              .update({ position: index })
              .eq('id', milestone.id)
              .eq('goal_id', goal.id)
          );

        if (!updates.length) {
          return;
        }

        const responses = await Promise.all(updates);
        const failed = responses.find((response) => response?.error);
        if (failed?.error) {
          throw failed.error;
        }
      }

      async function persistTodoOrder(goal, milestone) {
        if (!currentUserId || !goal?.id || !milestone?.id) {
          return;
        }

        const updates = milestone.todos
          .filter((todo) => todo?.id)
          .map((todo, index) =>
            supabaseClient
              .from('goal_milestone_todos')
              .update({ position: index })
              .eq('id', todo.id)
              .eq('milestone_id', milestone.id)
          );

        if (!updates.length) {
          return;
        }

        const responses = await Promise.all(updates);
        const failed = responses.find((response) => response?.error);
        if (failed?.error) {
          throw failed.error;
        }
      }

      const reorderWithDrag = (items, fromIndex, toIndex, placeBefore) => {
        const updated = Array.from(items);
        const [moved] = updated.splice(fromIndex, 1);

        if (placeBefore) {
          let insertIndex = toIndex;
          if (fromIndex < toIndex) {
            insertIndex -= 1;
          }
          updated.splice(insertIndex < 0 ? 0 : insertIndex, 0, moved);
        } else {
          let insertIndex = toIndex;
          if (fromIndex > toIndex) {
            insertIndex += 1;
          }
          updated.splice(insertIndex, 0, moved);
        }

        return updated;
      };

      function setupDragAndDrop(listElement, items, onReorder) {
        if (!listElement || !Array.isArray(items) || items.length === 0) {
          listElement.ondragover = null;
          listElement.ondrop = null;
          return;
        }

        const handleListDragOver = (event) => {
          event.preventDefault();
          event.dataTransfer.dropEffect = 'move';
        };

        const handleListDrop = (event) => {
          if (event.target.closest('[data-draggable-index]')) {
            return;
          }

          event.preventDefault();
          const sourceIndex = Number.parseInt(event.dataTransfer.getData('text/plain'), 10);
          if (Number.isNaN(sourceIndex)) {
            return;
          }

          const updated = Array.from(items);
          const [moved] = updated.splice(sourceIndex, 1);
          updated.push(moved);
          onReorder(updated);
        };

        listElement.ondragover = handleListDragOver;
        listElement.ondrop = handleListDrop;

        Array.from(listElement.children).forEach((child) => {
          const handleDragStart = (event) => {
            const index = Number.parseInt(child.dataset.draggableIndex || '-1', 10);
            if (Number.isNaN(index)) {
              return;
            }
            child.classList.add('is-dragging');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', String(index));
          };

          const handleDragEnd = () => {
            child.classList.remove('is-dragging');
            child.classList.remove('is-drag-over');
            child.style.removeProperty('--drop-indicator');
          };

          const handleDragOver = (event) => {
            event.preventDefault();
            const draggingIndex = Number.parseInt(event.dataTransfer.getData('text/plain'), 10);
            const currentIndex = Number.parseInt(child.dataset.draggableIndex || '-1', 10);
            if (Number.isNaN(draggingIndex) || Number.isNaN(currentIndex) || draggingIndex === currentIndex) {
              return;
            }
            const rect = child.getBoundingClientRect();
            const dropBefore = event.clientY < rect.top + rect.height / 2;
            child.classList.add('is-drag-over');
            child.style.setProperty('--drop-indicator', dropBefore ? '0%' : '100%');
            event.dataTransfer.dropEffect = 'move';
          };

          const handleDragLeave = () => {
            child.classList.remove('is-drag-over');
            child.style.removeProperty('--drop-indicator');
          };

          const handleDrop = (event) => {
            event.preventDefault();
            const sourceIndex = Number.parseInt(event.dataTransfer.getData('text/plain'), 10);
            const targetIndex = Number.parseInt(child.dataset.draggableIndex || '-1', 10);
            if (Number.isNaN(sourceIndex) || Number.isNaN(targetIndex) || sourceIndex === targetIndex) {
              child.classList.remove('is-drag-over');
              child.style.removeProperty('--drop-indicator');
              return;
            }

            const rect = child.getBoundingClientRect();
            const dropBefore = event.clientY < rect.top + rect.height / 2;
            const updated = reorderWithDrag(items, sourceIndex, targetIndex, dropBefore);
            child.classList.remove('is-drag-over');
            child.style.removeProperty('--drop-indicator');
            onReorder(updated);
          };

          child.addEventListener('dragstart', handleDragStart);
          child.addEventListener('dragend', handleDragEnd);
          child.addEventListener('dragover', handleDragOver);
          child.addEventListener('dragleave', handleDragLeave);
          child.addEventListener('drop', handleDrop);
      });
    }

    function reorderTodosAfterCompletion(milestone, todo) {
      if (!milestone || typeof milestone !== 'object' || !Array.isArray(milestone.todos) || !todo) {
        return;
      }

      const todos = milestone.todos;
      const currentIndex = todos.indexOf(todo);
      if (currentIndex === -1) {
        return;
      }

      todos.splice(currentIndex, 1);

      if (todo.completed) {
        let insertIndex = todos.findIndex((item) => item && item.completed);
        if (insertIndex === -1) {
          insertIndex = todos.length;
        }
        todos.splice(insertIndex, 0, todo);
      } else {
        const firstCompletedIndex = todos.findIndex((item) => item && item.completed);
        const insertIndex = firstCompletedIndex === -1 ? todos.length : firstCompletedIndex;
        todos.splice(insertIndex, 0, todo);
      }

      todos.forEach((todoItem, index) => {
        if (todoItem) {
          todoItem.position = index;
        }
      });
    }

    function updateMilestoneHeadingButton(goal) {
      if (!milestoneHeadingButton) {
        return;
      }

      const headingLabel = 'Milepæler';
      const hasMilestones = Array.isArray(goal?.milestones) && goal.milestones.length > 0;

      if (!hasMilestones) {
        milestoneHeadingButton.disabled = true;
        milestoneHeadingButton.dataset.state = 'closed';
        milestoneHeadingButton.setAttribute('aria-expanded', 'false');
        milestoneHeadingButton.innerHTML = `
          <span class="goal-section__title-text">${headingLabel}</span>
          <span class="goal-section__title-icon" aria-hidden="true">${getIconMarkup('chevronsDown')}</span>
          <span class="goal-sr-only">Ingen milepæler tilgjengelig</span>
        `;
        return;
      }

      const allCollapsed = goal.milestones.every((milestone) => !Boolean(milestone?.isExpanded));
      const srText = allCollapsed ? 'Vis alle milepæler' : 'Skjul alle milepæler';
      const iconName = allCollapsed ? 'chevronsDown' : 'chevronsUp';
      milestoneHeadingButton.disabled = false;
      milestoneHeadingButton.dataset.state = allCollapsed ? 'closed' : 'open';
      milestoneHeadingButton.setAttribute('aria-expanded', allCollapsed ? 'false' : 'true');
      milestoneHeadingButton.innerHTML = `
        <span class="goal-section__title-text">${headingLabel}</span>
        <span class="goal-section__title-icon" aria-hidden="true">${getIconMarkup(iconName)}</span>
        <span class="goal-sr-only">${srText}</span>
      `;
    }

    function updateGoalSummary(goal) {
      if (!goalSummarySection) {
        return;
      }

      ensureGoalCollections(goal);

      const milestones = Array.isArray(goal?.milestones) ? goal.milestones : [];
      const todos = milestones.reduce((accumulator, milestone) => {
        if (Array.isArray(milestone?.todos)) {
          accumulator.push(...milestone.todos);
        }
        return accumulator;
      }, []);

      const totalTodos = todos.length;
      const completedTodos = todos.filter((todo) => Boolean(todo?.completed)).length;
      const totalMilestones = milestones.length;
      const completedMilestones = milestones.filter((milestone) => Boolean(milestone?.completed)).length;

      const progress = totalTodos > 0 ? Math.round((completedTodos / totalTodos) * 100) : 0;
      const progressFraction = Math.max(0, Math.min(1, totalTodos > 0 ? completedTodos / totalTodos : 0));

      if (goalSummaryProgressValue) {
        goalSummaryProgressValue.textContent = `${progress}%`;
      }

      if (goalSummaryProgressBar) {
        goalSummaryProgressBar.style.transform = `scaleX(${progressFraction})`;
      }

      if (goalSummaryProgressTrack) {
        goalSummaryProgressTrack.setAttribute('aria-valuenow', String(progress));
      }

      if (goalSummaryProgressDescription) {
        goalSummaryProgressDescription.textContent = totalTodos
          ? `${completedTodos} av ${totalTodos} to-dos fullført`
          : 'Ingen to-dos registrert';
      }

      if (goalSummaryMilestoneStatus) {
        goalSummaryMilestoneStatus.textContent = `Milepæler ${completedMilestones}/${totalMilestones} fullført`;
      }

      goalSummarySection.removeAttribute('hidden');
    }

      function toggleMilestoneTodos(goal, milestoneIndex) {
        if (!goal || !Array.isArray(goal.milestones)) {
          return;
        }

        ensureGoalCollections(goal);
        const milestone = goal.milestones[milestoneIndex];
        if (!milestone || typeof milestone !== 'object') {
          return;
        }

        milestone.isExpanded = !Boolean(milestone.isExpanded);
        renderMilestones(goal);
      }

      function setAllMilestoneTodos(goal, shouldExpand) {
        if (!goal || !Array.isArray(goal.milestones)) {
          return;
        }

        ensureGoalCollections(goal);
        goal.milestones.forEach((milestone) => {
          if (!milestone || typeof milestone !== 'object') {
            return;
          }

          milestone.isExpanded = shouldExpand ? true : false;
        });

        renderMilestones(goal);
      }

      function createMilestoneStatusIndicator(todos) {
        const todosArray = Array.isArray(todos) ? todos : [];
        const totalCount = todosArray.length;
        const completedCount = todosArray.filter((todo) => Boolean(todo?.completed)).length;
        const statusDescription = totalCount
          ? `${completedCount} av ${totalCount} to-dos fullført`
          : 'Ingen to-dos registrert';

        const indicator = document.createElement('div');
        indicator.className = 'goal-milestone__status';
        indicator.title = statusDescription;

        const ring = document.createElement('div');
        ring.className = 'goal-milestone__status-ring';
        let progressDegrees = 0;
        if (totalCount > 0) {
          const progressFraction = completedCount / totalCount;
          progressDegrees = Math.max(0, Math.min(359.9, progressFraction * 360));
          if (completedCount === totalCount) {
            ring.style.setProperty('--goal-status-color', '#16a34a');
          }
        }
        ring.style.setProperty('--goal-status-degree', `${progressDegrees}deg`);

        const countSpan = document.createElement('span');
        countSpan.className = 'goal-milestone__status-count';
        countSpan.textContent = `${completedCount}/${totalCount || 0}`;
        countSpan.setAttribute('aria-hidden', 'true');
        ring.appendChild(countSpan);

        const srText = document.createElement('span');
        srText.className = 'goal-sr-only';
        srText.textContent = statusDescription;
        indicator.appendChild(srText);

        indicator.appendChild(ring);

        const label = document.createElement('span');
        label.className = 'goal-milestone__status-label';
        label.textContent = 'fullført';
        label.setAttribute('aria-hidden', 'true');
        indicator.appendChild(label);

        return indicator;
      }

      function renderMilestones(goal) {
      if (!milestoneList) {
        return;
      }

      milestoneList.innerHTML = '';
      ensureGoalCollections(goal);

      const goalDomIdentifier = goal?.id ?? getGoalDomIdentifier();

      updateMilestoneHeadingButton(goal);
      updateGoalSummary(goal);

      if (!goal.milestones.length) {
        const emptyItem = document.createElement('li');
        emptyItem.className = 'empty-state';
        emptyItem.textContent = 'Legg til milepælene dine her.';
          milestoneList.appendChild(emptyItem);
          milestoneList.ondragover = null;
          milestoneList.ondrop = null;
          return;
        }

        goal.milestones.forEach((milestone, index) => {
          const item = document.createElement('li');
          item.className = 'goal-list__item goal-milestone';
          item.draggable = true;
          item.dataset.draggableIndex = String(index);
          item.dataset.completed = milestone.completed ? 'true' : 'false';

          const todosContainerId = `goal-milestone-${index}-todos`;
          const todos = Array.isArray(milestone.todos) ? milestone.todos : [];

          if (milestone.progress) {
            item.dataset.progress = milestone.progress;
          } else {
            item.removeAttribute('data-progress');
          }

          const header = document.createElement('div');
          header.className = 'goal-milestone__header';

          const label = document.createElement('div');
          label.className = 'goal-list__label';

          const titleSpan = document.createElement('span');
          titleSpan.textContent = milestone.title;
          label.appendChild(titleSpan);

          if (milestone.detail) {
            const detailSpan = document.createElement('span');
            detailSpan.textContent = milestone.detail;
            label.appendChild(detailSpan);
          }

          const formattedMilestoneDeadline = formatShortDeadline(milestone.deadline);
          if (formattedMilestoneDeadline) {
            const deadlineSpan = document.createElement('span');
            deadlineSpan.className = 'goal-milestone__deadline';
            deadlineSpan.textContent = `Deadline: ${formattedMilestoneDeadline}`;
            label.appendChild(deadlineSpan);
          }

          const info = document.createElement('div');
          info.className = 'goal-milestone__info';
          const statusIndicator = createMilestoneStatusIndicator(todos);
          info.appendChild(statusIndicator);
          info.appendChild(label);

          header.appendChild(info);

          const actions = document.createElement('div');
          actions.className = 'goal-milestone__actions';

          const trimmedTitle = (milestone.title || '').trim();
          const editButton = document.createElement('button');
          editButton.type = 'button';
          editButton.className = 'goal-icon-button goal-milestone__edit';
          editButton.dataset.milestoneIndex = String(index);
          const editLabel = trimmedTitle ? `Rediger milepælen ${trimmedTitle}` : 'Rediger milepælen';
          editButton.setAttribute('aria-label', editLabel);
          editButton.title = editLabel;
          setButtonIconContent(editButton, 'pencil', editLabel);
          editButton.addEventListener('click', () => {
            openMilestoneEditModal(goal, index);
          });

          const isExpanded = Boolean(milestone.isExpanded);
          const toggleButton = document.createElement('button');
          toggleButton.type = 'button';
          toggleButton.className = 'goal-icon-button goal-milestone__toggle';
          toggleButton.dataset.state = isExpanded ? 'open' : 'closed';
          toggleButton.setAttribute('aria-expanded', isExpanded ? 'true' : 'false');
          toggleButton.setAttribute('aria-controls', todosContainerId);
          const toggleSrText = isExpanded
            ? trimmedTitle
              ? `Skjul to-dos for milepælen ${trimmedTitle}`
              : 'Skjul to-dos for denne milepælen'
            : trimmedTitle
              ? `Vis to-dos for milepælen ${trimmedTitle}`
              : 'Vis to-dos for denne milepælen';
          setButtonIconContent(toggleButton, isExpanded ? 'chevronsUp' : 'chevronsDown', toggleSrText);
          toggleButton.addEventListener('click', () => {
            toggleMilestoneTodos(goal, index);
          });

          const isTodoFormOpen = Boolean(milestone.isTodoFormOpen);
          const todoAddButton = document.createElement('button');
          todoAddButton.type = 'button';
          todoAddButton.className = 'goal-icon-button goal-milestone__todo-add';
          todoAddButton.dataset.state = isTodoFormOpen ? 'open' : 'closed';
          todoAddButton.setAttribute('aria-expanded', isTodoFormOpen ? 'true' : 'false');
          const addSrText = isTodoFormOpen
            ? trimmedTitle
              ? `Lukk skjema for ny to-do i milepælen ${trimmedTitle}`
              : 'Lukk skjema for ny to-do'
            : trimmedTitle
              ? `Legg til ny to-do i milepælen ${trimmedTitle}`
              : 'Legg til ny to-do';
          setButtonIconContent(todoAddButton, isTodoFormOpen ? 'close' : 'plus', addSrText);
          todoAddButton.addEventListener('click', () => {
            const shouldOpen = !Boolean(milestone.isTodoFormOpen);
            milestone.isTodoFormOpen = shouldOpen;
            if (shouldOpen) {
              milestone.shouldFocusTodoTitle = true;
            }
            renderMilestones(goal);
          });

          actions.appendChild(editButton);
          actions.appendChild(toggleButton);
          actions.appendChild(todoAddButton);

          header.appendChild(actions);

          item.appendChild(header);

          const todosContainer = document.createElement('div');
          todosContainer.className = 'goal-milestone__todos';
          todosContainer.id = todosContainerId;
          todosContainer.hidden = !isExpanded;

          const todoContent = document.createElement('div');
          todoContent.className = 'goal-milestone__todo-content';
          todosContainer.appendChild(todoContent);

          const todoListElement = document.createElement('ul');
          todoListElement.className = 'goal-milestone__todo-list';
          todoContent.appendChild(todoListElement);

          if (!todos.length) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.textContent = 'Ingen to-dos knyttet til denne milepælen ennå.';
            todoContent.appendChild(emptyState);
          } else {
            todos.forEach((todo, todoIndex) => {
              const todoItem = document.createElement('li');
              todoItem.className = 'goal-list__item goal-milestone__todo-item';
              todoItem.draggable = true;
              todoItem.dataset.draggableIndex = String(todoIndex);
              todoItem.dataset.completed = todo.completed ? 'true' : 'false';

              const todoWrapper = document.createElement('div');
              todoWrapper.className = 'goal-list__todo';

              const todoMain = document.createElement('div');
              todoMain.className = 'goal-list__todo-main';

              const checkbox = document.createElement('input');
              checkbox.type = 'checkbox';
              const checkboxId = `goal-${goalDomIdentifier}-milestone-${index}-todo-${todoIndex}`;
              checkbox.id = checkboxId;
              checkbox.checked = Boolean(todo.completed);
              checkbox.addEventListener('click', (event) => {
                event.stopPropagation();
              });
              checkbox.addEventListener('change', async () => {
                const newValue = checkbox.checked;
                const previousValue = Boolean(todo.completed);
                if (newValue === previousValue) {
                  return;
                }

                const previousTodos = milestone.todos.slice();
                const previousPositions = previousTodos.map((todoItem) =>
                  typeof todoItem.position === 'number' ? todoItem.position : null
                );
                const previousCompletionStates = previousTodos.map((todoItem) => Boolean(todoItem.completed));

                todo.completed = newValue;
                reorderTodosAfterCompletion(milestone, todo);
                renderMilestones(goal);
                try {
                  await updateTodoCompletionInDatabase(todo, newValue);
                  await persistTodoOrder(goal, milestone);
                } catch (completionError) {
                  console.error('Feil ved oppdatering av to-do', completionError);
                  todo.completed = previousValue;
                  milestone.todos = previousTodos;
                  milestone.todos.forEach((todoItem, idx) => {
                    todoItem.position = previousPositions[idx] ?? idx;
                    todoItem.completed = previousCompletionStates[idx];
                  });
                  renderMilestones(goal);
                }
              });

              const todoLabel = document.createElement('label');
              todoLabel.setAttribute('for', checkboxId);

              const todoTitleSpan = document.createElement('span');
              todoTitleSpan.className = 'goal-list__todo-title';
              todoTitleSpan.textContent = todo.title;
              todoLabel.appendChild(todoTitleSpan);

              todoMain.appendChild(checkbox);
              todoMain.appendChild(todoLabel);

              const todoActions = document.createElement('div');
              todoActions.className = 'goal-list__todo-actions';

              const deleteButton = document.createElement('button');
              deleteButton.type = 'button';
              deleteButton.className = 'goal-milestone__todo-delete';
              const todoTitleTrimmed = (todo.title || '').trim();
              const deleteLabel = todoTitleTrimmed ? `Slett to-do ${todoTitleTrimmed}` : 'Slett to-do';
              setButtonIconContent(deleteButton, 'x', deleteLabel);
              deleteButton.addEventListener('click', async (event) => {
                event.stopPropagation();
                const previousTodos = milestone.todos.slice();
                const previousPositions = previousTodos.map((todoItem) =>
                  typeof todoItem.position === 'number' ? todoItem.position : null
                );
                const previousCompletionStates = previousTodos.map((todoItem) => Boolean(todoItem.completed));
                const currentIndex = milestone.todos.indexOf(todo);
                if (currentIndex === -1) {
                  return;
                }

                milestone.todos.splice(currentIndex, 1);
                milestone.todos.forEach((todoItem, updatedIndex) => {
                  todoItem.position = updatedIndex;
                });
                renderMilestones(goal);

                try {
                  if (todo.id) {
                    await deleteTodoFromDatabase(todo);
                  }
                  await persistTodoOrder(goal, milestone);
                } catch (deleteError) {
                  console.error('Feil ved sletting av to-do', deleteError);
                  milestone.todos = previousTodos;
                  milestone.todos.forEach((todoItem, idx) => {
                    todoItem.position = previousPositions[idx] ?? idx;
                    todoItem.completed = previousCompletionStates[idx];
                  });
                  renderMilestones(goal);
                }
              });

              todoActions.appendChild(deleteButton);

              todoWrapper.appendChild(todoMain);
              todoWrapper.appendChild(todoActions);
              todoItem.appendChild(todoWrapper);
              todoListElement.appendChild(todoItem);
            });

            setupDragAndDrop(todoListElement, todos, async (updated) => {
              milestone.todos = updated;
              milestone.todos.forEach((todoItem, updatedIndex) => {
                todoItem.position = updatedIndex;
              });
              renderMilestones(goal);
              try {
                await persistTodoOrder(goal, milestone);
              } catch (orderError) {
                console.error('Feil ved lagring av rekkefølge for to-dos', orderError);
              }
            });
          }

          const todoForm = document.createElement('form');
          todoForm.className = 'goal-milestone__todo-form';
          if (!isTodoFormOpen) {
            todoForm.setAttribute('hidden', '');
          }

          const todoTitleInput = document.createElement('input');
          todoTitleInput.type = 'text';
          todoTitleInput.name = 'todo-title';
          todoTitleInput.placeholder = 'Legg til to-do';
          todoTitleInput.required = true;

          const todoSubmit = document.createElement('button');
          todoSubmit.type = 'submit';
          todoSubmit.innerHTML = '<span aria-hidden="true">+</span><span class="goal-sr-only">Legg til to-do</span>';

          todoForm.appendChild(todoTitleInput);
          todoForm.appendChild(todoSubmit);

          if (isTodoFormOpen && milestone.shouldFocusTodoTitle) {
            requestAnimationFrame(() => {
              todoTitleInput.focus();
            });
            milestone.shouldFocusTodoTitle = false;
          }

          todoForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const titleValue = todoTitleInput.value.trim();
            if (!titleValue) {
              return;
            }

            const position = 0;
            const newTodo = {
              title: titleValue,
              detail: '',
              completed: false,
              milestoneId: milestone.id ?? null,
              id: null,
              position
            };

            milestone.todos.unshift(newTodo);
            milestone.todos.forEach((todoItem, updatedIndex) => {
              todoItem.position = updatedIndex;
            });
            milestone.isExpanded = true;

            todoForm.reset();
            milestone.isTodoFormOpen = false;
            milestone.shouldFocusTodoTitle = false;
            renderMilestones(goal);

            if (currentGoal?.id && milestone.id) {
              try {
                const insertedTodo = await insertTodoIntoDatabase(currentGoal, milestone, {
                  title: titleValue,
                  detail: '',
                  position
                });
                if (insertedTodo) {
                  const mappedTodo = mapDatabaseTodo(insertedTodo, position, { fallbackMilestoneId: milestone.id });
                  milestone.todos[0] = { ...milestone.todos[0], ...mappedTodo };
                  milestone.todos.forEach((todoItem, updatedIndex) => {
                    todoItem.position = updatedIndex;
                  });
                  renderMilestones(goal);
                }
                try {
                  await persistTodoOrder(goal, milestone);
                } catch (orderError) {
                  console.error('Feil ved lagring av rekkefølge for to-dos', orderError);
                }
              } catch (todoError) {
                console.error('Feil ved lagring av to-do', todoError);
                milestone.todos.shift();
                milestone.todos.forEach((todoItem, updatedIndex) => {
                  todoItem.position = updatedIndex;
                });
                renderMilestones(goal);
              }
            }
          });

          todosContainer.insertBefore(todoForm, todosContainer.firstChild);
          item.appendChild(todosContainer);
          milestoneList.appendChild(item);
        });

        setupDragAndDrop(milestoneList, goal.milestones, async (updated) => {
          goal.milestones = updated;
          goal.milestones.forEach((milestoneItem, milestoneIndex) => {
            milestoneItem.position = milestoneIndex;
          });
          renderMilestones(goal);
          try {
            await persistMilestoneOrder(goal);
          } catch (orderError) {
            console.error('Feil ved lagring av rekkefølge for milepæler', orderError);
          }
        });
      }

      if (milestoneHeadingButton) {
        milestoneHeadingButton.addEventListener('click', () => {
          if (!currentGoal) {
            return;
          }

          ensureGoalCollections(currentGoal);
          const allCollapsed = currentGoal.milestones.every((milestone) => !Boolean(milestone?.isExpanded));
          setAllMilestoneTodos(currentGoal, allCollapsed);
        });
      }

      if (milestoneDeleteButton) {
        milestoneDeleteButton.addEventListener('click', async () => {
          if (milestoneEditIndex === null || !currentGoal) {
            return;
          }

          ensureGoalCollections(currentGoal);
          const targetIndex = milestoneEditIndex;
          const milestone = currentGoal.milestones?.[targetIndex];
          if (!milestone) {
            return;
          }

          const trimmedTitle = (milestone.title || '').trim();
          const confirmMessage = trimmedTitle
            ? `Er du sikker på at du vil slette milepælen "${trimmedTitle}"?`
            : 'Er du sikker på at du vil slette milepælen?';

          if (!window.confirm(confirmMessage)) {
            return;
          }

          closeMilestoneEditModal({ restoreFocus: false });

          const previousMilestones = currentGoal.milestones.slice();
          const previousPositions = previousMilestones.map((milestoneItem, index) =>
            typeof milestoneItem?.position === 'number' ? milestoneItem.position : index
          );

          const [removedMilestone] = currentGoal.milestones.splice(targetIndex, 1);
          currentGoal.milestones.forEach((milestoneItem, index) => {
            milestoneItem.position = index;
          });

          renderMilestones(currentGoal);

          try {
            if (removedMilestone?.id) {
              await deleteMilestoneFromDatabase(removedMilestone);
            }
            await persistMilestoneOrder(currentGoal);
          } catch (deleteError) {
            console.error('Feil ved sletting av milepæl', deleteError);
            currentGoal.milestones = previousMilestones;
            currentGoal.milestones.forEach((milestoneItem, index) => {
              milestoneItem.position = previousPositions[index] ?? index;
            });
            renderMilestones(currentGoal);
          }
        });
      }

      if (milestoneCompleteButton) {
        milestoneCompleteButton.addEventListener('click', async () => {
          if (milestoneEditIndex === null || !currentGoal || milestoneCompleteButton.disabled) {
            return;
          }

          ensureGoalCollections(currentGoal);
          const milestone = currentGoal.milestones?.[milestoneEditIndex];
          if (!milestone) {
            return;
          }

          const previousState = Boolean(milestone.completed);
          const nextState = !previousState;

          milestone.completed = nextState;
          updateMilestoneCompleteButtonState({ completed: nextState });
          renderMilestones(currentGoal);

          try {
            if (milestone.id) {
              await updateMilestoneInDatabase(milestone, { completed: nextState });
            }
          } catch (milestoneError) {
            console.error('Feil ved oppdatering av milepæl', milestoneError);
            milestone.completed = previousState;
            updateMilestoneCompleteButtonState({ completed: previousState });
            renderMilestones(currentGoal);
          }
        });
      }

      function renderNotes(goal) {
        if (!notesList) {
          return;
        }

        notesList.innerHTML = '';
        ensureGoalCollections(goal);

        if (notesSearchInput) {
          notesSearchInput.value = noteSearchQuery;
        }

        const query = noteSearchQuery.trim().toLowerCase();
        const filteredNotes = goal.notes
          .map((note, index) => ({ note, index }))
          .filter(({ note }) => {
            if (!query) {
              return true;
            }

            const searchableText = `${note.title || ''} ${getNotePlainText(note)}`.toLowerCase();
            return searchableText.includes(query);
          });

        if (!filteredNotes.length) {
          const empty = document.createElement('div');
          empty.className = 'empty-state';
          empty.textContent = query
            ? 'Ingen notater matcher søket ditt.'
            : 'Ingen notater ennå. Skriv ned viktige tanker eller ressurser her.';
          notesList.appendChild(empty);
          return;
        }

        filteredNotes.forEach(({ note, index }) => {
          const noteItem = document.createElement('article');
          noteItem.className = 'goal-note';
          noteItem.dataset.noteIndex = String(index);

          const openButton = document.createElement('button');
          openButton.type = 'button';
          openButton.className = 'goal-note__open';
          openButton.dataset.noteIndex = String(index);

          const heading = document.createElement('h4');
          heading.className = 'goal-note__title';
          heading.textContent = note.title || 'Notat';
          openButton.appendChild(heading);

          const previewText = getNotePlainText(note);
          if (previewText) {
            const preview = document.createElement('p');
            preview.className = 'goal-note__preview';
            preview.textContent = previewText.length > 120
              ? `${previewText.slice(0, 117)}…`
              : previewText;
            openButton.appendChild(preview);
          }

          openButton.addEventListener('click', () => {
            openNoteModal(note, index);
          });

          noteItem.appendChild(openButton);

          notesList.appendChild(noteItem);
        });
      }

      async function deleteGoalNote(noteIndex) {
        if (!currentGoal) {
          return false;
        }

        const parsedIndex = Number.parseInt(noteIndex, 10);
        if (!Number.isInteger(parsedIndex) || parsedIndex < 0) {
          return false;
        }

        ensureGoalCollections(currentGoal);
        if (parsedIndex >= currentGoal.notes.length) {
          return false;
        }

        const targetNote = currentGoal.notes[parsedIndex];
        const trimmedTitle = (targetNote?.title || '').trim();
        const confirmMessage = trimmedTitle
          ? `Er du sikker på at du vil slette notatet "${trimmedTitle}"?`
          : 'Er du sikker på at du vil slette dette notatet?';

        if (!window.confirm(confirmMessage)) {
          return false;
        }

        const [removedNote] = currentGoal.notes.splice(parsedIndex, 1);
        renderNotes(currentGoal);

        requestAnimationFrame(() => {
          const focusTarget = notesList?.querySelector('.goal-note__open');
          if (focusTarget) {
            focusTarget.focus();
          } else {
            addNoteButton?.focus();
          }
        });

        try {
          if (removedNote?.id) {
            await deleteNoteFromDatabase(removedNote);
          }
          return true;
        } catch (noteError) {
          console.error('Feil ved sletting av notat', noteError);
          currentGoal.notes.splice(parsedIndex, 0, removedNote);
          renderNotes(currentGoal);
          window.alert('Kunne ikke slette notatet. Prøv igjen.');
          requestAnimationFrame(() => {
            const selector = `.goal-note[data-note-index="${parsedIndex}"] .goal-note__open`;
            const fallbackTarget = notesList?.querySelector(selector) || notesList?.querySelector('.goal-note__open');
            fallbackTarget?.focus();
          });
          return false;
        }
      }

      function renderGoalDetail(goal) {
        if (!goalDetailSection) {
          return;
        }

        ensureGoalCollections(goal);
        setMilestoneFormVisibility(false);

        goalDetailTitle.textContent = goal.title || '';
        goalDetailWhy.textContent = goal.description || goal.why || '';
        goalDetailDeadline.textContent = formatLongDeadline(goal.deadline);
        goalDetailCategory.textContent = goal.category || 'Personlig mål';
        goalDetailImportant.textContent = goal.important || goal.why || 'Holder meg motivert';

        const imageSource = goal.image || '';
        if (imageSource) {
          goalDetailImage.src = imageSource;
          goalDetailImage.alt = goal.title ? `Illustrasjon for ${goal.title}` : '';
        } else {
          goalDetailImage.removeAttribute('src');
          goalDetailImage.alt = '';
        }

        renderMilestones(goal);
        renderNotes(goal);
      }

      function openMilestoneEditModal(goal, milestoneIndex) {
        if (!milestoneEditModal || !milestoneEditForm) {
          return;
        }

        ensureGoalCollections(goal);
        const milestone = goal?.milestones?.[milestoneIndex];
        if (!milestone) {
          return;
        }

        milestoneEditIndex = milestoneIndex;

        const titleField = milestoneEditForm['milestone-title'];
        const detailField = milestoneEditForm['milestone-detail'];
        const deadlineField = milestoneEditForm['milestone-deadline'];

        if (titleField) {
          titleField.value = milestone.title || '';
        }

        if (detailField) {
          detailField.value = milestone.detail || '';
        }

        if (deadlineField) {
          deadlineField.value = formatDateForInput(milestone.deadline);
          deadlineField.dataset.originalValue = milestone.deadline || '';
        }

        if (milestoneDeleteButton) {
          const trimmedTitle = (milestone.title || '').trim();
          const deleteLabel = trimmedTitle
            ? `Slett milepælen ${trimmedTitle}`
            : 'Slett milepælen';
          setButtonIconContent(milestoneDeleteButton, 'x', deleteLabel);
          milestoneDeleteButton.dataset.milestoneIndex = String(milestoneIndex);
          milestoneDeleteButton.disabled = false;
        }

        updateMilestoneCompleteButtonState({
          completed: Boolean(milestone.completed),
          disabled: false
        });

        milestoneEditModal.removeAttribute('hidden');
        milestoneEditModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();

        requestAnimationFrame(() => {
          titleField?.focus();
        });
      }

      function closeMilestoneEditModal({ restoreFocus = true } = {}) {
        if (!milestoneEditModal || !milestoneEditForm) {
          return;
        }

        const previousIndex = milestoneEditIndex;
        milestoneEditIndex = null;

        milestoneEditModal.setAttribute('hidden', '');
        milestoneEditModal.setAttribute('aria-hidden', 'true');
        const editDeadlineField = milestoneEditForm['milestone-deadline'];
        if (editDeadlineField) {
          delete editDeadlineField.dataset.originalValue;
        }
        milestoneEditForm.reset();
        if (milestoneDeleteButton) {
          delete milestoneDeleteButton.dataset.milestoneIndex;
          milestoneDeleteButton.disabled = true;
          setButtonIconContent(milestoneDeleteButton, 'x', 'Slett milepælen');
        }
        updateMilestoneCompleteButtonState({ completed: false, disabled: true });
        unlockBodyScroll();

        if (restoreFocus && previousIndex !== null && milestoneList) {
          const selector = `.goal-milestone[data-draggable-index="${previousIndex}"] .goal-milestone__edit`;
          const editButton = milestoneList.querySelector(selector);
          editButton?.focus();
        }
      }

      function openNoteModal(note, index = null) {
        if (!noteModal) {
          return;
        }

        const normalizedNote = note?.__isSanitized ? note : normalizeGoalNote(note);
        noteModalTitle.textContent = normalizedNote.title || 'Notat';
        const contentHtml = normalizedNote.content || '';
        if (contentHtml) {
          noteModalContent.innerHTML = contentHtml;
        } else {
          const plainText = getNotePlainText(normalizedNote);
          noteModalContent.innerHTML = plainText ? `<p>${escapeHtml(plainText)}</p>` : '';
        }

        const parsedModalIndex = Number.parseInt(String(index ?? ''), 10);
        noteModalIndex = Number.isInteger(parsedModalIndex) ? parsedModalIndex : null;

        if (noteModalEditButton) {
          if (noteModalIndex !== null) {
            noteModalEditButton.disabled = false;
            noteModalEditButton.dataset.noteIndex = String(noteModalIndex);
          } else {
            noteModalEditButton.disabled = true;
            delete noteModalEditButton.dataset.noteIndex;
          }
        }

        if (noteModalDeleteButton) {
          if (noteModalIndex !== null) {
            noteModalDeleteButton.disabled = false;
            noteModalDeleteButton.dataset.noteIndex = String(noteModalIndex);
          } else {
            noteModalDeleteButton.disabled = true;
            delete noteModalDeleteButton.dataset.noteIndex;
          }
        }

        noteModal.removeAttribute('hidden');
        noteModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();
        requestAnimationFrame(() => {
          noteModalClose?.focus();
        });
      }

      function closeNoteModal({ restoreFocus = true } = {}) {
        if (!noteModal) {
          return;
        }

        noteModal.setAttribute('hidden', '');
        noteModal.setAttribute('aria-hidden', 'true');
        unlockBodyScroll();

        if (noteModalEditButton) {
          noteModalEditButton.disabled = true;
          delete noteModalEditButton.dataset.noteIndex;
        }

        if (noteModalDeleteButton) {
          noteModalDeleteButton.disabled = true;
          delete noteModalDeleteButton.dataset.noteIndex;
        }

        const previousIndex = noteModalIndex;
        noteModalIndex = null;

        if (restoreFocus) {
          let focusTarget = null;
          if (previousIndex !== null) {
            focusTarget = notesList?.querySelector(
              `.goal-note[data-note-index="${previousIndex}"] .goal-note__open`
            );
          }

          if (!focusTarget) {
            focusTarget = notesList?.querySelector('.goal-note__open');
          }

          focusTarget?.focus();
        }
      }

      function openNoteCreateModal({ mode = 'create', note = null, index = null } = {}) {
        if (!noteCreateModal) {
          return;
        }

        noteCreateForm?.reset();
        noteEditIndex = mode === 'edit' ? index : null;

        if (noteCreateTitle) {
          noteCreateTitle.textContent = mode === 'edit' ? 'Rediger notat' : 'Nytt notat';
        }

        if (noteCreateSubmitButton) {
          noteCreateSubmitButton.textContent = mode === 'edit' ? 'Oppdater notat' : 'Lagre notat';
        }

        const titleField = noteCreateForm?.querySelector('input[name="note-title"]');
        if (titleField) {
          titleField.value = mode === 'edit' ? (note?.title || '') : '';
        }

        const normalizedNote = mode === 'edit' && note ? (note.__isSanitized ? note : normalizeGoalNote(note)) : null;
        const noteHtml = normalizedNote?.content || '';
        setNoteEditorContent(noteHtml);

        const hiddenContentField = noteCreateForm?.querySelector('input[name="note-content"]');
        if (hiddenContentField) {
          hiddenContentField.value = noteHtml;
        }

        noteCreateModal.removeAttribute('hidden');
        noteCreateModal.setAttribute('aria-hidden', 'false');
        lockBodyScroll();
        requestAnimationFrame(() => {
          if (titleField) {
            titleField.focus();
            if (mode === 'edit' && titleField.value) {
              titleField.select();
            }
          }
          updateToolbarState();
        });
      }

      function closeNoteCreateModal({ restoreFocus = true } = {}) {
        if (!noteCreateModal) {
          return;
        }

        noteCreateModal.setAttribute('hidden', '');
        noteCreateModal.setAttribute('aria-hidden', 'true');
        unlockBodyScroll();
        noteEditIndex = null;
        noteCreateForm?.reset();
        setNoteEditorContent('');
        const hiddenContentField = noteCreateForm?.querySelector('input[name="note-content"]');
        if (hiddenContentField) {
          hiddenContentField.value = '';
        }

        if (noteCreateTitle) {
          noteCreateTitle.textContent = 'Nytt notat';
        }

        if (noteCreateSubmitButton) {
          noteCreateSubmitButton.textContent = 'Lagre notat';
        }
        updateToolbarState();

        if (restoreFocus) {
          addNoteButton?.focus();
        }
      }

      function showGoalDetail(goal) {
        if (!goalDetailSection) {
          return;
        }

        renderGoalDetail(goal);
        goalDetailSection.removeAttribute('hidden');
        emptyStateSection?.setAttribute('hidden', '');
      }

      function showEmptyState() {
        goalDetailSection?.setAttribute('hidden', '');
        emptyStateSection?.removeAttribute('hidden');
        setMilestoneFormVisibility(false);
      }

      if (goalDetailBackButton) {
        goalDetailBackButton.addEventListener('click', () => {
          if (window.history.length > 1) {
            window.history.back();
          } else {
            window.location.href = 'mal.html';
          }
        });
      }

      if (milestoneEditModal) {
        milestoneEditModal.addEventListener('click', (event) => {
          if (event.target === milestoneEditModal) {
            closeMilestoneEditModal();
          }
        });
      }

      if (milestoneEditClose) {
        milestoneEditClose.addEventListener('click', () => closeMilestoneEditModal());
      }

      if (noteModal) {
        noteModal.addEventListener('click', (event) => {
          if (event.target === noteModal) {
            closeNoteModal();
          }
        });
      }

      if (noteModalClose) {
        noteModalClose.addEventListener('click', () => closeNoteModal());
      }

      if (noteModalEditButton) {
        noteModalEditButton.addEventListener('click', () => {
          const noteIndexValue = noteModalEditButton.dataset.noteIndex ?? '';
          const parsedIndex = Number.parseInt(noteIndexValue, 10);
          if (!Number.isInteger(parsedIndex) || !currentGoal) {
            return;
          }

          ensureGoalCollections(currentGoal);
          if (parsedIndex < 0 || parsedIndex >= currentGoal.notes.length) {
            return;
          }

          const noteToEdit = currentGoal.notes[parsedIndex];
          closeNoteModal({ restoreFocus: false });
          openNoteCreateModal({ mode: 'edit', note: noteToEdit, index: parsedIndex });
        });
      }

      if (noteModalDeleteButton) {
        noteModalDeleteButton.addEventListener('click', async () => {
          const noteIndexValue = noteModalDeleteButton.dataset.noteIndex ?? '';
          const parsedIndex = Number.parseInt(noteIndexValue, 10);
          if (!Number.isInteger(parsedIndex)) {
            return;
          }

          const deleted = await deleteGoalNote(parsedIndex);
          if (deleted) {
            closeNoteModal({ restoreFocus: false });
          }
        });
      }

      if (noteToolbar && noteEditor) {
        noteToolbar.addEventListener('click', (event) => {
          const button = event.target.closest('button');
          if (!button) {
            return;
          }

          const { command } = button.dataset;
          if (!command) {
            return;
          }

          event.preventDefault();
          noteEditor.focus();

          try {
            document.execCommand(command, false);
          } catch (error) {
            console.warn('Kunne ikke oppdatere formatering', error);
          }

          updateToolbarState();
        });
      }

      if (noteCreateModal) {
        noteCreateModal.addEventListener('click', (event) => {
          if (event.target === noteCreateModal) {
            closeNoteCreateModal();
          }
        });
      }

      if (noteCreateClose) {
        noteCreateClose.addEventListener('click', () => closeNoteCreateModal());
      }

      if (noteEditor) {
        noteEditor.addEventListener('input', () => updateToolbarState());
        noteEditor.addEventListener('keyup', () => updateToolbarState());
        noteEditor.addEventListener('mouseup', () => updateToolbarState());
        noteEditor.addEventListener('paste', (event) => {
          event.preventDefault();
          const text = event.clipboardData?.getData('text/plain');
          if (typeof text === 'string') {
            document.execCommand('insertText', false, text);
            updateToolbarState();
          }
        });
      }

      document.addEventListener('selectionchange', () => {
        if (!noteEditor) {
          return;
        }

        const selection = document.getSelection();
        const anchorNode = selection?.anchorNode || null;
        if (anchorNode instanceof Node && noteEditor.contains(anchorNode)) {
          updateToolbarState();
        }
      });

      if (notesSearchInput) {
        notesSearchInput.addEventListener('input', () => {
          noteSearchQuery = notesSearchInput.value;
          if (currentGoal) {
            renderNotes(currentGoal);
          }
        });
      }

      if (addNoteButton) {
        addNoteButton.addEventListener('click', () => openNoteCreateModal());
      }

      if (milestoneFormToggle) {
        milestoneFormToggle.addEventListener('click', () => {
          const shouldOpen = !milestoneFormIsOpen;
          setMilestoneFormVisibility(shouldOpen, { focusField: shouldOpen });
        });
      }

      if (noteCreateForm) {
        noteCreateForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!currentGoal) {
            return;
          }

          ensureGoalCollections(currentGoal);

          const titleField = noteCreateForm['note-title'];
          const titleValue = titleField?.value.trim() || '';
          const contentHtml = getNoteEditorHtml();

          const headingTexts = (() => {
            if (!contentHtml) {
              return [];
            }
            const temp = document.createElement('div');
            temp.innerHTML = contentHtml;
            return Array.from(temp.querySelectorAll('h2, h3, h4'))
              .map((heading) => (heading.textContent || '').trim())
              .filter(Boolean);
          })();

          let plainText = extractPlainTextFromHtml(contentHtml);
          if (!plainText && headingTexts.length) {
            plainText = headingTexts.join(' ');
          }

          if (!titleValue || (!plainText && !headingTexts.length)) {
            return;
          }

          const hiddenContentField = noteCreateForm['note-content'];
          if (hiddenContentField) {
            hiddenContentField.value = contentHtml;
          }

          const notePayload = {
            title: titleValue,
            content: contentHtml,
            plainText
          };

          if (noteEditIndex !== null) {
            const editIndex = noteEditIndex;
            const existingNote = currentGoal.notes[editIndex];
            if (!existingNote) {
              return;
            }

            const previousNote = { ...existingNote };
            const updatedNote = normalizeGoalNote({
              ...existingNote,
              ...notePayload
            });

            currentGoal.notes[editIndex] = updatedNote;
            renderNotes(currentGoal);
            closeNoteCreateModal({ restoreFocus: false });

            const focusEditedButton = () => {
              const selector = `.goal-note[data-note-index="${editIndex}"] .goal-note__open`;
              const editedButton = notesList?.querySelector(selector);
              editedButton?.focus();
            };

            requestAnimationFrame(focusEditedButton);

            try {
              if (existingNote.id) {
                const savedNote = await updateNoteInDatabase(existingNote, {
                  title: updatedNote.title,
                  contentHtml: updatedNote.content,
                  contentPlain: updatedNote.plainText
                });
                if (savedNote) {
                  currentGoal.notes[editIndex] = mapDatabaseNote(savedNote, {
                    fallbackGoalId: currentGoal.id ?? existingNote.goalId ?? null
                  });
                  renderNotes(currentGoal);
                  requestAnimationFrame(focusEditedButton);
                }
              } else if (currentGoal.id) {
                const insertedNote = await insertNoteIntoDatabase(currentGoal, {
                  title: updatedNote.title,
                  contentHtml: updatedNote.content,
                  contentPlain: updatedNote.plainText
                });
                if (insertedNote) {
                  currentGoal.notes[editIndex] = mapDatabaseNote(insertedNote, {
                    fallbackGoalId: currentGoal.id
                  });
                  renderNotes(currentGoal);
                  requestAnimationFrame(focusEditedButton);
                }
              }
            } catch (noteError) {
              console.error('Feil ved oppdatering av notat', noteError);
              currentGoal.notes[editIndex] = previousNote;
              renderNotes(currentGoal);
              window.alert('Kunne ikke oppdatere notatet. Prøv igjen.');
              requestAnimationFrame(focusEditedButton);
            }

            return;
          }

          const newNote = normalizeGoalNote(notePayload);
          const placeholderId = `temp-note-${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;
          newNote.__localId = placeholderId;
          const previousNotes = currentGoal.notes.slice();
          const previousSearchQuery = noteSearchQuery;
          currentGoal.notes.unshift(newNote);

          noteSearchQuery = '';
          renderNotes(currentGoal);
          closeNoteCreateModal({ restoreFocus: false });

          const focusFirstNote = () => {
            const [firstNote] = notesList?.querySelectorAll('.goal-note__open') || [];
            if (firstNote) {
              firstNote.focus();
            } else {
              addNoteButton?.focus();
            }
          };

          requestAnimationFrame(focusFirstNote);

          try {
            if (currentGoal.id) {
              const insertedNote = await insertNoteIntoDatabase(currentGoal, {
                title: newNote.title,
                contentHtml: newNote.content,
                contentPlain: newNote.plainText
              });

              if (insertedNote) {
                const normalizedInserted = mapDatabaseNote(insertedNote, {
                  fallbackGoalId: currentGoal.id
                });

                const placeholderIndex = currentGoal.notes.findIndex(
                  (note) => note.__localId && note.__localId === placeholderId
                );
                if (placeholderIndex !== -1) {
                  currentGoal.notes[placeholderIndex] = {
                    ...currentGoal.notes[placeholderIndex],
                    ...normalizedInserted
                  };
                  delete currentGoal.notes[placeholderIndex].__localId;
                } else {
                  currentGoal.notes = currentGoal.notes.filter(
                    (note) => note.__localId !== placeholderId
                  );
                  currentGoal.notes.unshift(normalizedInserted);
                }

                renderNotes(currentGoal);
                requestAnimationFrame(focusFirstNote);
              }
            }
          } catch (noteError) {
            console.error('Feil ved lagring av notat', noteError);
            currentGoal.notes = previousNotes;
            noteSearchQuery = previousSearchQuery;
            renderNotes(currentGoal);
            window.alert('Kunne ikke lagre notatet. Prøv igjen.');
            requestAnimationFrame(() => {
              addNoteButton?.focus();
            });
          }
        });
      }

      if (milestoneEditForm) {
        milestoneEditForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!currentGoal || milestoneEditIndex === null) {
            return;
          }

          ensureGoalCollections(currentGoal);
          const milestone = currentGoal.milestones[milestoneEditIndex];
          if (!milestone) {
            return;
          }

          const previousTitle = milestone.title;
          const previousDetail = milestone.detail;
          const previousDeadline = milestone.deadline;

          const titleField = milestoneEditForm['milestone-title'];
          const detailField = milestoneEditForm['milestone-detail'];
          const deadlineField = milestoneEditForm['milestone-deadline'];

          const titleValue = titleField?.value.trim();
          const detailValue = detailField?.value.trim();
          const deadlineValue = deadlineField?.value;
          const originalDeadline = deadlineField?.dataset?.originalValue || '';
          const originalWasInvalid = Boolean(originalDeadline) && !formatDateForInput(originalDeadline);

          if (!titleValue) {
            return;
          }

          milestone.title = titleValue;
          milestone.detail = detailValue || '';
          if (deadlineValue) {
            milestone.deadline = deadlineValue;
          } else if (originalWasInvalid) {
            milestone.deadline = originalDeadline;
          } else {
            milestone.deadline = '';
          }
          milestone.isExpanded = true;

          const editedIndex = milestoneEditIndex;

          renderMilestones(currentGoal);
          closeMilestoneEditModal({ restoreFocus: false });

          try {
            if (milestone.id) {
              await updateMilestoneInDatabase(milestone, {
                title: titleValue,
                detail: detailValue || null,
                deadline: milestone.deadline ? milestone.deadline : null
              });
            }
          } catch (milestoneError) {
            console.error('Feil ved oppdatering av milepæl', milestoneError);
            milestone.title = previousTitle;
            milestone.detail = previousDetail;
            milestone.deadline = previousDeadline;
            renderMilestones(currentGoal);
          } finally {
            requestAnimationFrame(() => {
              const selector = `.goal-milestone[data-draggable-index="${editedIndex}"] .goal-milestone__edit`;
              const editButton = milestoneList?.querySelector(selector);
              editButton?.focus();
            });
          }
        });
      }

      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          if (milestoneEditModal && !milestoneEditModal.hasAttribute('hidden')) {
            closeMilestoneEditModal();
          } else if (noteCreateModal && !noteCreateModal.hasAttribute('hidden')) {
            closeNoteCreateModal();
          } else if (noteModal && !noteModal.hasAttribute('hidden')) {
            closeNoteModal();
          }
        }
      });

      if (milestoneForm) {
        milestoneForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!currentGoal) {
            return;
          }

          ensureGoalCollections(currentGoal);
          const titleField = milestoneForm['milestone-title'];
          const detailField = milestoneForm['milestone-detail'];
          const titleValue = titleField?.value.trim();
          const detailValue = detailField?.value.trim();

          if (!titleValue) {
            return;
          }

          const position = 0;
          let insertedMilestone = null;

          if (currentGoal.id) {
            try {
              insertedMilestone = await insertMilestoneIntoDatabase(currentGoal, {
                title: titleValue,
                detail: detailValue,
                position,
                deadline: ''
              });
            } catch (milestoneError) {
              console.error('Feil ved lagring av milepæl', milestoneError);
            }
          }

          const milestonePayload = insertedMilestone ?? {
            goal_id: currentGoal.id ?? null,
            title: titleValue,
            detail: detailValue,
            completed: false,
            deadline: '',
            position
          };

          const newMilestone = mapDatabaseMilestone(milestonePayload, position, {
            fallbackGoalId: currentGoal.id ?? null
          });
          newMilestone.isExpanded = true;
          newMilestone.isTodoFormOpen = false;
          newMilestone.shouldFocusTodoTitle = false;

          currentGoal.milestones.unshift(newMilestone);
          currentGoal.milestones.forEach((milestone, index) => {
            milestone.position = index;
          });

          milestoneForm.reset();
          setMilestoneFormVisibility(false);
          renderMilestones(currentGoal);

          if (currentGoal.id) {
            try {
              await persistMilestoneOrder(currentGoal);
            } catch (orderError) {
              console.error('Feil ved lagring av rekkefølge for milepæler', orderError);
            }
          }
        });
      }

      async function initializeGoal() {
        try {
          const { data, error } = await supabaseClient.auth.getSession();

          if (error) {
            throw error;
          }

          if (!data?.session) {
            window.location.replace('login.html');
            return;
          }

          currentUserId = data.session.user.id;
        } catch (authError) {
          console.error('Feil ved henting av sesjon', authError);
          window.location.replace('login.html');
          return;
        }

        if (goalIdentifier) {
          const loadedGoal = await loadGoalFromDatabase(goalIdentifier);
          if (loadedGoal) {
            currentGoal = loadedGoal;
            fallbackGoalIndex = null;
          }
        }

        if (!currentGoal && fallbackGoalIndex !== null) {
          const fallbackGoal = baseGoalsData[fallbackGoalIndex];
          if (fallbackGoal) {
            currentGoal = cloneGoal(fallbackGoal);
          }
        }

        if (currentGoal) {
          ensureGoalCollections(currentGoal);
        }
      }

      await initializeGoal();

      if (currentGoal) {
        showGoalDetail(currentGoal);
      } else {
        showEmptyState();
      }
    })();
  </script>
</body>
</html>
